<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyFlow - ChatBot Central</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #6366F1;
      --primary-dark: #4F46E5;
      --primary-light: #8B5CF6;
      --secondary: #06B6D4;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --light: #FFFFFF;
      --dark: #1E293B;
      --gray: #64748B;
      --light-gray: #F1F5F9;
      --dark-gray: #334155;
      --chat-bg: #F8FAFC;
      --user-bubble: #E0E7FF;
      --bot-bubble: #FFFFFF;
      --border-radius: 16px;
      --border-radius-sm: 8px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s ease-out;
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.2);
    }
    
    .dark-theme {
      --primary: #818CF8;
      --primary-dark: #6366F1;
      --primary-light: #A78BFA;
      --light: #0F172A;
      --dark: #F1F5F9;
      --gray: #94A3B8;
      --light-gray: #1E293B;
      --dark-gray: #CBD5E1;
      --chat-bg: #0F172A;
      --user-bubble: #312E81;
      --bot-bubble: #1E293B;
      --glass-bg: rgba(30, 41, 59, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--dark);
      height: 100vh;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      overflow: hidden;
    }
    
    .chatbot-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
      background-color: var(--chat-bg);
      position: relative;
      overflow: hidden;
    }
    
    .chatbot-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 85% 30%, rgba(6, 182, 212, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 50% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 20%);
      background-size: 100% 100%;
      z-index: 0;
    }
    
    .chatbot-header {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      color: var(--dark);
      padding: 0.9rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
      z-index: 10;
      position: relative;
      border-bottom: 1px solid var(--glass-border);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    
    .bot-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      color: white;
      box-shadow: var(--shadow-lg);
      transition: var(--transition);
    }
    
    .bot-avatar:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-xl);
    }
    
    .header-info h1 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 3px;
      letter-spacing: -0.025em;
    }
    
    .header-info p {
      font-size: 0.85rem;
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--success);
      display: inline-block;
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      }
      70% {
        box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
      }
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
    }
    
    .header-btn {
      background: transparent;
      border: none;
      color: var(--gray);
      width: 38px;
      height: 38px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .header-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--primary);
      opacity: 0;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .header-btn:hover {
      color: var(--light);
      transform: translateY(-2px);
    }
    
    .header-btn:hover::before {
      opacity: 1;
    }
    
    .header-btn i {
      position: relative;
      z-index: 1;
    }
    
    .chat-messages {
      display: flex;
      flex-direction: column;
      padding: 1.2rem;
      overflow-y: auto;
      flex: 1;
      gap: 12px;
      scroll-behavior: smooth;
      position: relative;
      z-index: 1;
    }
    
    .message-container {
      display: flex;
      margin-bottom: 4px;
      animation: messageAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .bot-container {
      justify-content: flex-start;
    }
    
    .user-container {
      justify-content: flex-end;
    }
    
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      flex-shrink: 0;
      align-self: flex-end;
      margin-bottom: 6px;
      box-shadow: var(--shadow);
    }
    
    .bot-avatar-small {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-size: 0.95rem;
    }
    
    .user-avatar-small {
      background: var(--secondary);
      color: white;
      font-size: 0.95rem;
    }
    
    .message-bubble {
      position: relative;
      padding: 14px 18px;
      border-radius: var(--border-radius);
      max-width: 80%;
      margin-bottom: 2px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      box-shadow: var(--shadow);
      line-height: 1.5;
      transition: var(--transition-fast);
    }
    
    @keyframes messageAppear {
      from {
        opacity: 0;
        transform: translateY(15px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .bot-bubble {
      background: var(--bot-bubble);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      color: var(--dark);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .user-bubble {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      color: white;
      box-shadow: var(--shadow-lg);
    }
    
    .bubble-time {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 6px;
      text-align: right;
      font-weight: 500;
    }
    
    .user-bubble .bubble-time {
      color: rgba(255, 255, 255, 0.8);
    }
    
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 14px 18px;
      background-color: var(--bot-bubble);
      border-radius: var(--border-radius);
      border-bottom-left-radius: 4px;
      align-self: flex-start;
      width: fit-content;
      margin-bottom: 8px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .typing-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--gray);
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) {
      animation-delay: -0.32s;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: -0.16s;
    }
    
    @keyframes typingAnimation {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .chatbot-input {
      display: flex;
      padding: 1rem 1.5rem;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--glass-border);
      gap: 10px;
      align-items: center;
      position: relative;
      z-index: 10;
    }
    
    .chatbot-input input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 24px;
      border: 1px solid var(--glass-border);
      background: var(--light);
      color: var(--dark);
      font-size: 0.95rem;
      outline: none;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }
    
    .chatbot-input input:focus {
      background: var(--light);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
      border-color: var(--primary);
    }
    
    .input-actions {
      display: flex;
      gap: 6px;
    }
    
    .input-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--gray);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .input-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--light-gray);
      opacity: 0;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .input-btn:hover {
      color: var(--primary);
      transform: translateY(-2px);
    }
    
    .input-btn:hover::before {
      opacity: 1;
    }
    
    .input-btn i {
      position: relative;
      z-index: 1;
    }
    
    .send-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }
    
    .send-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.1);
      opacity: 0;
      transition: var(--transition);
    }
    
    .send-btn:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-xl);
    }
    
    .send-btn:hover::before {
      opacity: 1;
    }
    
    .message-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    
    .message-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-size: 0.8rem;
      box-shadow: var(--shadow-sm);
    }
    
    .message-title {
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--dark);
    }
    
    .message-subtitle {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--dark);
      margin-bottom: 6px;
    }
    
    .message-text {
      font-size: 0.95rem;
      line-height: 1.5;
      color: var(--dark);
    }
    
    .message-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--gray), transparent);
      margin: 12px 0;
      opacity: 0.3;
    }
    
    .message-section {
      margin: 12px 0;
    }
    
    .message-section-title {
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 8px;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .message-list {
      list-style-type: none;
      margin: 10px 0;
      padding-left: 0;
    }
    
    .message-list-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      transition: var(--transition-fast);
    }
    
    .message-list-item:hover {
      background-color: rgba(0, 0, 0, 0.02);
      border-radius: var(--border-radius-sm);
      padding-left: 8px;
      padding-right: 8px;
      margin: 0 -8px;
    }
    
    .message-list-item:last-child {
      border-bottom: none;
    }
    
    .message-list-icon {
      width: 18px;
      text-align: center;
      color: var(--primary);
      margin-top: 2px;
      flex-shrink: 0;
    }
    
    .message-list-content {
      flex: 1;
    }
    
    .message-list-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 3px;
    }
    
    .message-list-description {
      font-size: 0.85rem;
      color: var(--gray);
      line-height: 1.4;
    }
    
    .message-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 14px 0;
    }
    
    .message-stat {
      background: var(--light-gray);
      padding: 12px;
      border-radius: var(--border-radius-sm);
      text-align: center;
      box-shadow: var(--shadow-sm);
      transition: var(--transition-fast);
    }
    
    .message-stat:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .message-stat-value {
      font-size: 1.4rem;
      font-weight: 800;
      margin: 4px 0;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .message-stat-label {
      font-size: 0.8rem;
      color: var(--gray);
      font-weight: 600;
    }
    
    .message-progress {
      margin: 12px 0;
    }
    
    .message-progress-bar {
      height: 8px;
      background-color: var(--light-gray);
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .message-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--primary));
      border-radius: 4px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    
    .message-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background-image: linear-gradient(
        -45deg,
        rgba(255, 255, 255, 0.2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0.2) 75%,
        transparent 75%,
        transparent
      );
      background-size: 20px 20px;
      animation: move 1s linear infinite;
    }
    
    @keyframes move {
      0% {
        background-position: 0 0;
      }
      100% {
        background-position: 20px 0;
      }
    }
    
    .message-progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--gray);
      font-weight: 600;
    }
    
    .message-alert {
      padding: 12px 14px;
      border-radius: var(--border-radius-sm);
      margin: 10px 0;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 0.95rem;
      box-shadow: var(--shadow-sm);
      border-left: 4px solid;
      transition: var(--transition-fast);
    }
    
    .message-alert:hover {
      transform: translateX(4px);
    }
    
    .message-alert-warning {
      background-color: rgba(245, 158, 11, 0.1);
      border-left-color: var(--warning);
    }
    
    .message-alert-danger {
      background-color: rgba(239, 68, 68, 0.1);
      border-left-color: var(--danger);
    }
    
    .message-alert-success {
      background-color: rgba(16, 185, 129, 0.1);
      border-left-color: var(--success);
    }
    
    .message-alert-info {
      background-color: rgba(6, 182, 212, 0.1);
      border-left-color: var(--secondary);
    }
    
    .message-card {
      background: var(--bot-bubble);
      border-radius: var(--border-radius);
      padding: 18px;
      margin: 12px 0;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--primary);
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .message-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .message-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .message-card-title {
      font-weight: 700;
      font-size: 1.15rem;
      color: var(--dark);
    }
    
    .message-card-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .message-muted {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 6px;
      line-height: 1.4;
    }
    
    .message-badge {
      display: inline-block;
      padding: 3px 10px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      margin-left: 8px;
      box-shadow: var(--shadow-sm);
    }
    
    .message-badge-warning {
      background: linear-gradient(135deg, var(--warning), #F97316);
    }
    
    .message-badge-danger {
      background: linear-gradient(135deg, var(--danger), #DC2626);
    }
    
    .message-badge-success {
      background: linear-gradient(135deg, var(--success), #059669);
    }
    
    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 14px 0;
      justify-content: center;
    }
    
    .action-btn {
      padding: 12px 18px;
      background: var(--bot-bubble);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      transition: var(--transition);
      color: var(--dark);
      box-shadow: var(--shadow-sm);
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }
    
    .action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--primary);
      opacity: 0;
      transition: var(--transition);
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      color: white;
    }
    
    .action-btn:hover::before {
      opacity: 1;
    }
    
    .action-btn i {
      position: relative;
      z-index: 1;
    }
    
    .action-btn span {
      position: relative;
      z-index: 1;
    }
    
    .action-btn.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
    }
    
    .action-btn.secondary {
      background: linear-gradient(135deg, var(--secondary), #0EA5E9);
      color: white;
      border: none;
    }
    
    .action-btn.info {
      background: var(--light-gray);
      color: var(--dark);
    }
    
    .action-btn.reset {
      background: linear-gradient(135deg, var(--danger), #DC2626);
      color: white;
      border: none;
    }
    
    .chat-date {
      text-align: center;
      color: var(--gray);
      font-size: 0.85rem;
      margin: 14px 0;
      position: relative;
      font-weight: 600;
    }
    
    .chat-date::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(to right, transparent, var(--gray), transparent);
      z-index: 1;
      opacity: 0.3;
    }
    
    .chat-date span {
      background-color: var(--chat-bg);
      padding: 0 14px;
      position: relative;
      z-index: 2;
    }
    
    .message-reaction {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }
    
    .reaction-icon {
      font-size: 0.75rem;
      color: var(--gray);
    }
    
    @media (max-width: 768px) {
      .chatbot-container {
        height: 100vh;
      }
      .message-bubble {
        max-width: 85%;
      }
      .message-stats {
        grid-template-columns: 1fr;
      }
      .quick-actions {
        justify-content: flex-start;
      }
      .action-btn {
        flex: 1;
        min-width: calc(50% - 5px);
        justify-content: center;
      }
    }
    
    .typing-text {
      overflow: hidden;
      white-space: nowrap;
      animation: typing 3.5s steps(40, end);
    }
    
    @keyframes typing {
      from { width: 0 }
      to { width: 100% }
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
      animation: modalFadeIn 0.3s;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      animation: modalSlideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid var(--glass-border);
    }
    
    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.9) translateY(-20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    .modal-header {
      padding: 1.4rem 1.8rem;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }
    
    .modal-header h3 {
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 1.6rem;
      cursor: pointer;
      color: var(--gray);
      transition: var(--transition);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-modal:hover {
      color: var(--dark);
      background: rgba(0, 0, 0, 0.05);
    }
    
    .modal-body {
      padding: 1.8rem;
    }
    
    .tasks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.2rem;
      margin-bottom: 1.8rem;
    }
    
    .task-card {
      background: var(--light);
      border-radius: var(--border-radius);
      padding: 1.6rem;
      border: 1px solid var(--glass-border);
      transition: var(--transition);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    
    .task-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }
    
    .task-card.disabled {
      opacity: 0.7;
    }
    
    .task-card.active {
      opacity: 1;
      border-color: var(--primary);
      background: var(--light);
      box-shadow: var(--shadow-lg);
    }
    
    .task-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-xl);
    }
    
    .task-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 1.2rem;
    }
    
    .task-icon-large {
      font-size: 1.6rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .task-title {
      font-weight: 700;
      font-size: 1.2rem;
      flex: 1;
    }
    
    .task-description {
      color: var(--gray);
      font-size: 0.95rem;
      margin-bottom: 1.2rem;
      line-height: 1.5;
    }
    
    .task-form {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }
    
    .form-group {
      margin-bottom: 0;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 14px;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--glass-border);
      background-color: var(--light);
      color: var(--dark);
      font-size: 0.95rem;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }
    
    .form-group input:focus, .form-group select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--gray);
    }
    
    .empty-state i {
      font-size: 3.5rem;
      margin-bottom: 1.2rem;
      opacity: 0.5;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .modal-footer {
      padding: 1.4rem 1.8rem;
      border-top: 1px solid var(--glass-border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 0 0 var(--border-radius) var(--border-radius);
    }
    
    .btn {
      padding: 12px 24px;
      border-radius: var(--border-radius-sm);
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.1);
      opacity: 0;
      transition: var(--transition);
    }
    
    .btn:hover::before {
      opacity: 1;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-secondary {
      background: var(--light-gray);
      color: var(--dark);
    }
    
    .btn-secondary:hover {
      background: var(--gray);
      color: white;
      transform: translateY(-2px);
    }
    
    .activate-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      border-radius: var(--border-radius-sm);
      padding: 8px 16px;
      cursor: pointer;
      font-size: 0.85rem;
      margin-left: auto;
      transition: var(--transition);
      font-weight: 600;
      box-shadow: var(--shadow-sm);
    }
    
    .activate-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .task-card.disabled .activate-btn {
      display: block;
    }
    
    .task-card.active .activate-btn {
      display: none;
    }
    
    /* CORREÇÃO CRÍTICA: Permitir que o botão de ativar seja clicável mesmo em cards desabilitados */
    .task-card.disabled .activate-btn {
      pointer-events: all !important;
    }
    
    /* CORREÇÃO: Tornar os inputs editáveis apenas quando o card estiver ativo */
    .task-card.disabled input {
      pointer-events: none;
      background-color: rgba(255, 255, 255, 0.5);
    }
    
    .task-card.active input {
      pointer-events: all;
      background-color: var(--light);
    }
    
    /* NOVOS ESTILOS PARA O MODAL DE ONTEM - COR DIFERENCIADA */
    .yesterday-modal .modal-header {
      background: rgba(239, 68, 68, 0.1);
      border-bottom: 4px solid var(--danger);
    }
    
    .yesterday-modal .modal-header h3 {
      color: var(--danger);
    }
    
    .yesterday-modal .modal-footer .btn-primary {
      background: linear-gradient(135deg, var(--danger), #DC2626);
    }
    
    .yesterday-modal .modal-footer .btn-primary:hover {
      background: linear-gradient(135deg, #DC2626, #B91C1C);
    }
    
    /* Loading animation for messages */
    @keyframes shimmer {
      0% {
        background-position: -468px 0;
      }
      100% {
        background-position: 468px 0;
      }
    }
    
    .shimmer {
      animation-duration: 1.5s;
      animation-fill-mode: forwards;
      animation-iteration-count: infinite;
      animation-name: shimmer;
      animation-timing-function: linear;
      background: #f6f7f8;
      background: linear-gradient(to right, #eeeeee 8%, #dddddd 18%, #eeeeee 33%);
      background-size: 800px 104px;
      position: relative;
    }
    
    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
    
    /* NOVO: Estilos para o Avatar Animado */
    .avatar-assistente {
      position: fixed;
      z-index: 1000;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Estado Parado (Idle) - Miniatura no canto inferior direito */
    .avatar-assistente[data-estado="parado"] {
      bottom: 20px;
      right: 20px;
      width: 80px;
      height: 80px;
      transform: scale(0.5);
    }
    
    /* Estados Ouvindo e Falando - Centralizado */
    .avatar-assistente[data-estado="ouvindo"],
    .avatar-assistente[data-estado="falando"] {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
    }
    
    /* Container principal do avatar */
    .assistente {
      position: relative;
      width: 260px;
      height: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
      perspective: 900px;
      filter: drop-shadow(0 0 25px #7b5cff);
      animation: flutuarSuave 6s ease-in-out infinite;
    }
    
    @keyframes flutuarSuave {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    /* Anéis */
    .anel {
      position: absolute;
      border-radius: 50%;
      border: 2px solid rgba(160,80,255,0.3);
      filter: blur(0.4px);
      mix-blend-mode: lighten;
      animation-name: girar;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      transform-origin: center;
    }
    
    @keyframes girar {
      from { transform: rotate3d(var(--rx,1), var(--ry,0.5), var(--rz,0.2), 0deg); }
      to   { transform: rotate3d(var(--rx,1), var(--ry,0.5), var(--rz,0.2), 360deg); }
    }
    
    /* Anéis com eixos e velocidades diferentes */
    .anel.a1 { width: 280px; height:280px; --rx:1;   --ry:0.3; --rz:0.2; animation-duration: 15s; border-color: rgba(130,80,255,0.28); }
    .anel.a2 { width: 240px; height:240px; --rx:0.2; --ry:1;   --rz:0.4; animation-duration: 9s;  border-color: rgba(150,100,255,0.34); }
    .anel.a3 { width: 190px; height:190px; --rx:0.6; --ry:0.8; --rz:0.1; animation-duration: 20s; border-color: rgba(190,110,255,0.42); }
    .anel.a4 { width: 140px; height:140px; --rx:0.3; --ry:0.7; --rz:0.9; animation-duration: 26s; border-color: rgba(220,140,255,0.55); }
    
    /* Núcleo */
    .nucleo {
      position: relative;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: radial-gradient(circle, #b98aff, #25005c 75%);
      box-shadow:
        0 0 35px #8a5fff,
        inset 0 0 25px #c69eff,
        0 0 60px rgba(180,120,255,0.3);
      animation: pulsar 3s ease-in-out infinite;
      z-index: 10;
    }
    
    @keyframes pulsar {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 35px #8a5fff, inset 0 0 25px #c69eff;
      }
      50% {
        transform: scale(1.15);
        box-shadow: 0 0 55px #a87bff, inset 0 0 40px #d9aaff;
      }
    }
    
    /* Equalizador */
    .equalizador-circular {
      position: absolute;
      width: 260px;
      height: 260px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
      z-index: 5;
    }
    
    .onda {
      position: absolute;
      width: 4px;
      height: 25px;
      background: linear-gradient(to top, rgba(140,90,255,0.1), rgba(200,150,255,0.9));
      border-radius: 2px;
      transform-origin: center bottom;
      opacity: 0.7;
      animation: vibrar 1s ease-in-out infinite;
      mix-blend-mode: screen;
    }
    
    @keyframes vibrar {
      0%, 100% { transform: scaleY(0.4); opacity: 0.4; }
      50% { transform: scaleY(1.7); opacity: 1; }
    }
    
    /* Partículas */
    .particulas {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
      z-index: 1;
    }
    
    .particula {
      position: absolute;
      width: 3px;
      height: 3px;
      background: #b48dff;
      border-radius: 50%;
      opacity: 0.7;
      animation: flutuar linear infinite;
    }
    
    @keyframes flutuar {
      from { transform: translateY(100%) scale(0.6); opacity: 0.6; }
      to   { transform: translateY(-120%) scale(1.3); opacity: 0; }
    }
    
    /* Estados do Avatar */
    .assistente[data-estado="parado"] .anel {
      animation-play-state: running;
      filter: brightness(1);
    }
    
    .assistente[data-estado="ouvindo"] .anel {
      animation-duration: calc(var(--base-speed, 10s) / 3);
      filter: blur(0.8px) brightness(1.4);
    }
    
    .assistente[data-estado="falando"] .nucleo {
      animation: pulsarRapido 1.2s ease-in-out infinite;
    }
    
    @keyframes pulsarRapido {
      0%, 100% { transform: scale(1); box-shadow: 0 0 45px #b78dff, inset 0 0 30px #d9aaff; }
      50% { transform: scale(1.25); box-shadow: 0 0 75px #c59aff, inset 0 0 55px #e0b5ff; }
    }
    
    .assistente[data-estado="ouvindo"] .equalizador-circular .onda {
      animation-duration: 0.6s;
    }
    
    .assistente[data-estado="falando"] .equalizador-circular {
      opacity: 0;
    }
    
    /* Estilos para funcionalidades de voz */
    .microphone-btn {
      position: relative;
    }
    
    .microphone-btn.listening {
      background: var(--primary);
      color: white;
    }
    
    .microphone-btn.listening::before {
      opacity: 1;
    }
    
    .voice-commands-btn {
      position: relative;
    }
    
    .voice-commands-modal .modal-content {
      max-width: 600px;
    }
    
    .voice-command-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .voice-command-item:last-child {
      border-bottom: none;
    }
    
    .voice-command-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-radius: 50%;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    
    .voice-command-content {
      flex: 1;
    }
    
    .voice-command-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .voice-command-description {
      font-size: 0.9rem;
      color: var(--gray);
      line-height: 1.4;
    }
    
    .voice-command-example {
      font-size: 0.85rem;
      color: var(--primary);
      font-style: italic;
      margin-top: 4px;
    }
    
    .voice-feedback {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      display: none;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    
    .voice-feedback.show {
      display: block;
      animation: fadeInOut 3s forwards;
    }
    
    @keyframes fadeInOut {
      0% {
        opacity: 0;
        transform: translateX(-50%) translateY(10px);
      }
      20% {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      80% {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }
    }
    
    /* NOVO: Botão de narração no header */
    .narration-btn {
      position: relative;
    }
    
    .narration-btn.active {
      background: var(--primary);
      color: white;
    }
    
    .narration-btn.active::before {
      opacity: 1;
    }
    
    /* NOVO: Indicador de microfone no modal de registro */
    .modal-microphone-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-lg);
      z-index: 10;
    }
    
    .modal-microphone-btn:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-xl);
    }
    
    .modal-microphone-btn.listening {
      background: var(--danger);
      animation: pulse-microphone 1.5s infinite;
    }
    
    @keyframes pulse-microphone {
      0% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }
    
    .modal-microphone-indicator {
      position: absolute;
      top: 10px;
      right: 70px;
      background: var(--primary);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: none;
      z-index: 10;
      box-shadow: var(--shadow);
    }
    
    .modal-microphone-indicator.show {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Avatar Animado Integrado -->
  <div class="avatar-assistente" data-estado="parado">
    <div class="assistente" data-estado="parado">
      <div class="particulas"></div>
      <div class="anel a1"></div>
      <div class="anel a2"></div>
      <div class="anel a3"></div>
      <div class="anel a4"></div>
      <div class="equalizador-circular"></div>
      <div class="nucleo"></div>
    </div>
  </div>

  <div class="chatbot-container">
    <div class="chatbot-header">
      <div class="header-left">
        <div class="bot-avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="header-info">
          <h1>StudyFlow Assistant</h1>
          <p><span class="status-dot"></span> Online • Seu assistente de estudos</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" id="themeToggle">
          <i class="fas fa-moon"></i>
        </button>
        <!-- NOVO: Botão de controle de narração -->
        <button class="header-btn narration-btn" id="narrationToggle">
          <i class="fas fa-volume-up"></i>
        </button>
        <button class="header-btn" id="voiceCommandsBtn">
          <i class="fas fa-microphone-alt"></i>
        </button>
        <button class="header-btn" id="infoBtn">
          <i class="fas fa-info"></i>
        </button>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <!-- Mensagens serão adicionadas dinamicamente -->
    </div>
    <div class="chatbot-input">
      <div class="input-actions">
        <button class="input-btn" id="attachBtn">
          <i class="fas fa-paperclip"></i>
        </button>
        <button class="input-btn" id="emojiBtn">
          <i class="far fa-smile"></i>
        </button>
        <button class="input-btn microphone-btn" id="microphoneBtn">
          <i class="fas fa-microphone"></i>
        </button>
      </div>
      <input type="text" id="messageInput" placeholder="Digite uma mensagem...">
      <button class="send-btn" id="sendMessage">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
  
  <!-- Feedback de voz -->
  <div class="voice-feedback" id="voiceFeedback"></div>
  
  <!-- Modal de Comandos de Voz -->
  <div class="modal voice-commands-modal" id="voiceCommandsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-microphone-alt"></i> Comandos de Voz Disponíveis</h3>
        <button class="close-modal" id="closeVoiceCommandsModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-calendar-day"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Resumo do Dia</div>
            <div class="voice-command-description">Mostrar tarefas e progresso atual</div>
            <div class="voice-command-example">Exemplo: "Mostrar resumo do dia"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-plus-circle"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Registrar Atividade</div>
            <div class="voice-command-description">Abrir modal para registrar atividades</div>
            <div class="voice-command-example">Exemplo: "Registrar atividade"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-microphone-alt"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Registrar atividades por voz</div>
            <div class="voice-command-description">Registrar atividades usando comandos de voz</div>
            <div class="voice-command-example">Exemplo: "Registrar atividades por voz"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-history"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Registrar Atividades de Ontem</div>
            <div class="voice-command-description">Registrar atividades do dia anterior</div>
            <div class="voice-command-example">Exemplo: "Registrar atividades de ontem"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Edital</div>
            <div class="voice-command-description">Ver progresso no edital</div>
            <div class="voice-command-example">Exemplo: "Abrir edital"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Simulados</div>
            <div class="voice-command-description">Ver notas e relatórios de simulados</div>
            <div class="voice-command-example">Exemplo: "Mostrar simulados"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-calendar-alt"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Programar Simulado</div>
            <div class="voice-command-description">Definir intervalos para simulados</div>
            <div class="voice-command-example">Exemplo: "Programar simulado"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-chart-bar"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Relatório Periódico</div>
            <div class="voice-command-description">Gerar relatórios de desempenho</div>
            <div class="voice-command-example">Exemplo: "Gerar relatório"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-sync-alt"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Trocar Baralhos</div>
            <div class="voice-command-description">Corrigir manualmente a ordem dos baralhos do dia</div>
            <div class="voice-command-example">Exemplo: "Trocar baralhos"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-cog"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Configurar</div>
            <div class="voice-command-description">Ajustar quantidade de matérias por dia</div>
            <div class="voice-command-example">Exemplo: "Abrir configurações"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-question-circle"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Ajuda</div>
            <div class="voice-command-description">Mostrar mensagem de ajuda</div>
            <div class="voice-command-example">Exemplo: "Preciso de ajuda"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Reset</div>
            <div class="voice-command-description">Função temporária para corrigir travamentos</div>
            <div class="voice-command-example">Exemplo: "Fazer reset"</div>
          </div>
        </div>
        
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-microphone-slash"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Parar de Ouvir</div>
            <div class="voice-command-description">Interromper o reconhecimento de voz</div>
            <div class="voice-command-example">Exemplo: "Parar" ou "Cancelar"</div>
          </div>
        </div>
        
        <!-- NOVOS COMANDOS: Registro automático de atividades -->
        <div class="voice-command-item">
          <div class="voice-command-icon">
            <i class="fas fa-edit"></i>
          </div>
          <div class="voice-command-content">
            <div class="voice-command-title">Registro Automático</div>
            <div class="voice-command-description">Ativar atividades e preencher campos por voz</div>
            <div class="voice-command-example">Exemplo: "Ativar questões de matemática", "Preencher 20 questões feitas", "Salvar atividades"</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="closeVoiceCommandsModalBtn">Fechar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de Registro Dinâmico -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-plus-circle"></i> Registrar Atividades</h3>
        <button class="close-modal" id="closeRegisterModal">&times;</button>
      </div>
      <!-- BOTÃO DE MICROFONE REMOVIDO CONFORME SOLICITADO -->
      <div class="modal-body" id="registerModalBody">
        <!-- Conteúdo dinâmico será inserido aqui -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelRegister">Cancelar</button>
        <button class="btn btn-primary" id="saveRegister">Salvar Atividades Selecionadas</button>
      </div>
    </div>
  </div>
  
  <!-- NOVO MODAL: Registrar Atividades do Dia Anterior -->
  <div class="modal yesterday-modal" id="yesterdayModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-history"></i> Registrar Atividades de Ontem</h3>
        <button class="close-modal" id="closeYesterdayModal">&times;</button>
      </div>
      <!-- BOTÃO DE MICROFONE REMOVIDO CONFORME SOLICITADO -->
      <div class="modal-body" id="yesterdayModalBody">
        <!-- Conteúdo dinâmico será inserido aqui -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelYesterday">Cancelar</button>
        <button class="btn btn-primary" id="saveYesterday">Salvar Atividades de Ontem</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de Configuração de Matérias por Dia -->
  <div class="modal" id="configModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-cog"></i> Configurar Matérias por Dia</h3>
        <button class="close-modal" id="closeConfigModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="materiasPorDia">Quantidade de matérias por dia:</label>
          <input type="number" id="materiasPorDia" min="1" max="5" value="1">
        </div>
        <div class="message-muted">
          Esta configuração define quantas matérias serão mostradas no resumo diário.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelConfig">Cancelar</button>
        <button class="btn btn-primary" id="saveConfig">Salvar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Programar Simulado -->
  <div class="modal" id="simuladoModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-calendar-alt"></i> Programar Simulado</h3>
        <button class="close-modal" id="closeSimuladoModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="simuladoInterval">Intervalo entre simulados:</label>
          <select id="simuladoInterval">
            <option value="0">Nenhum (não programar)</option>
            <option value="7">7 dias</option>
            <option value="10">10 dias</option>
            <option value="15">15 dias</option>
            <option value="30">30 dias</option>
          </select>
        </div>
        <div class="message-muted">
          Quando chegar o dia do simulado, o chatbot irá alertar.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelSimulado">Cancelar</button>
        <button class="btn btn-primary" id="saveSimulado">Salvar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Relatório Periódico -->
  <div class="modal" id="relatorioModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-chart-bar"></i> Relatório Periódico</h3>
        <button class="close-modal" id="closeRelatorioModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="relatorioPeriodo">Período do relatório:</label>
          <select id="relatorioPeriodo">
            <option value="7">7 dias</option>
            <option value="15">15 dias</option>
            <option value="30">30 dias</option>
          </select>
        </div>
        <div class="message-muted">
          O relatório somará todos os dados do período selecionado e comparará com o período anterior.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelRelatorio">Cancelar</button>
        <button class="btn btn-primary" id="generateRelatorio">Gerar Relatório</button>
      </div>
    </div>
  </div>

  <script>
    // Classe principal do ChatBot 
    class StudyFlowChatBot {
      constructor() {
        this.currentTheme = localStorage.getItem('theme') || 'light';
        // Limitar histórico para apenas 3 mensagens
        this.chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        if (this.chatHistory.length > 3) {
          this.chatHistory = this.chatHistory.slice(-3);
        }
        this.messageIds = new Set(); // Para evitar duplicação
        
        // Configuração de matérias por dia
        this.materiasPorDia = parseInt(localStorage.getItem('studyFlow_materiasPorDia')) || 1;
        
        // Estado do dia atual
        this.today = new Date().toISOString().split('T')[0];
        
        // NOVO: Memória temporária para atividades do dia anterior
        this.yesterdayMemory = JSON.parse(localStorage.getItem('studyFlow_yesterdayMemory')) || {
          activities: {},
          date: null
        };
        
        // Configurações de voz
        this.isListening = false;
        this.recognition = null;
        this.synthesis = null;
        this.voices = [];
        
        // NOVO: Controle de narração
        this.narrationEnabled = localStorage.getItem('studyFlow_narrationEnabled') !== 'false';
        
        // NOVO: Estado para registro automático por voz
        this.voiceRegistrationActive = false;
        this.currentModal = null;
        
        this.init();
      }
      
      // FUNÇÃO ADICIONADA PARA CORRIGIR O ERRO
      formatTime(date) {
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
      }
      
      init() {
        this.initTheme();
        this.initChat();
        this.initEventListeners();
        this.initVoiceRecognition();
        this.initNarrationControl();
        this.initAvatar(); // Inicializar o avatar
        this.showWelcomeMessage();
        
        // NOVO: Atualizar memória temporária ao inicializar
        this.updateYesterdayMemory();
      }
      
      // NOVA FUNÇÃO: Inicializar o avatar
      initAvatar() {
        // Criar partículas
        const particulasContainer = document.querySelector('.particulas');
        for (let i = 0; i < 30; i++) {
          const p = document.createElement('div');
          p.classList.add('particula');
          p.style.left = Math.random() * 100 + '%';
          p.style.animationDuration = (3 + Math.random() * 4) + 's';
          p.style.animationDelay = Math.random() * 3 + 's';
          particulasContainer.appendChild(p);
        }

        // Criar equalizador
        const eq = document.querySelector('.equalizador-circular');
        const totalOndas = 64;
        for (let i = 0; i < totalOndas; i++) {
          const onda = document.createElement('div');
          onda.classList.add('onda');
          const angulo = (i / totalOndas) * 360;
          onda.style.transform = `rotate(${angulo}deg) translateY(-115px)`;
          onda.style.animationDelay = (i * 0.03) + 's';
          eq.appendChild(onda);
        }
        
        // Inicialmente, definir estado como parado
        this.mudarEstadoAvatar('parado');
      }
      
      // NOVA FUNÇÃO: Controlar estado do avatar
      mudarEstadoAvatar(estado) {
        const avatarAssistente = document.querySelector('.avatar-assistente');
        const assistente = document.querySelector('.assistente');
        
        if (avatarAssistente && assistente) {
          avatarAssistente.setAttribute('data-estado', estado);
          assistente.setAttribute('data-estado', estado);
        }
      }
      
      initTheme() {
        if (this.currentTheme === 'dark') {
          document.body.classList.add('dark-theme');
          document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
        }
      }
      
      // NOVO: Inicializar controle de narração
      initNarrationControl() {
        const narrationBtn = document.getElementById('narrationToggle');
        if (this.narrationEnabled) {
          narrationBtn.classList.add('active');
          narrationBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
        } else {
          narrationBtn.classList.remove('active');
          narrationBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
        }
      }
      
      // NOVO: Alternar narração
      toggleNarration() {
        this.narrationEnabled = !this.narrationEnabled;
        localStorage.setItem('studyFlow_narrationEnabled', this.narrationEnabled);
        this.initNarrationControl();
        
        // Feedback visual
        this.showVoiceFeedback(`Narração ${this.narrationEnabled ? 'ativada' : 'desativada'}`);
        
        // Falar o estado da narração se estiver sendo ativada
        if (this.narrationEnabled) {
          this.speakText(`Narração ativada. Todas as respostas serão faladas.`);
        }
      }
      
      initChat() {
        // Carregar histórico do chat
        if (this.chatHistory.length > 0) {
          this.chatHistory.forEach(msg => {
            this.addMessageToChat(msg.content, msg.isUser, msg.timestamp);
          });
        }
      }
      
      // NOVO: Inicializar reconhecimento de voz
      initVoiceRecognition() {
        // Verificar se o navegador suporta Web Speech API
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          this.recognition = new SpeechRecognition();
          
          // Configurar reconhecimento
          this.recognition.continuous = false;
          this.recognition.interimResults = false;
          this.recognition.lang = 'pt-BR';
          
          // Configurar síntese de voz
          this.synthesis = window.speechSynthesis;
          
          // Carregar vozes disponíveis
          this.loadVoices();
          
          // Eventos do reconhecimento
          this.recognition.onstart = () => {
            this.isListening = true;
            this.updateMicrophoneButton();
            this.mudarEstadoAvatar('ouvindo'); // Avatar no estado ouvindo
          };
          
          this.recognition.onend = () => {
            this.isListening = false;
            this.updateMicrophoneButton();
            this.mudarEstadoAvatar('parado'); // Avatar volta ao estado parado
          };
          
          this.recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            this.processVoiceCommand(transcript);
          };
          
          this.recognition.onerror = (event) => {
            console.error('Erro no reconhecimento de voz:', event.error);
            this.showVoiceFeedback(`Erro: ${event.error}`);
            this.isListening = false;
            this.updateMicrophoneButton();
            this.mudarEstadoAvatar('parado'); // Avatar volta ao estado parado
          };
        } else {
          console.warn('Seu navegador não suporta reconhecimento de voz');
          this.showVoiceFeedback('Seu navegador não suporta comandos de voz');
        }
      }
      
      // NOVO: Carregar vozes disponíveis
      loadVoices() {
        // Aguardar as vozes serem carregadas
        if (this.synthesis) {
          this.synthesis.onvoiceschanged = () => {
            this.voices = this.synthesis.getVoices();
          };
        }
      }
      
      // NOVO: Atualizar botão do microfone
      updateMicrophoneButton() {
        const microphoneBtn = document.getElementById('microphoneBtn');
        if (this.isListening) {
          microphoneBtn.classList.add('listening');
          microphoneBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
        } else {
          microphoneBtn.classList.remove('listening');
          microphoneBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        }
      }
      
      // NOVO: Mostrar feedback de voz
      showVoiceFeedback(message) {
        const voiceFeedback = document.getElementById('voiceFeedback');
        voiceFeedback.textContent = message;
        voiceFeedback.classList.add('show');
        
        setTimeout(() => {
          voiceFeedback.classList.remove('show');
        }, 3000);
      }
      
      // NOVO: Processar comando de voz
      processVoiceCommand(transcript) {
        const lowerTranscript = transcript.toLowerCase();
        this.showVoiceFeedback(`Comando: "${transcript}"`);
        
        // Adicionar transcrição como mensagem do usuário
        this.addUserMessage(transcript);
        
        // Processar comandos específicos
        if (lowerTranscript.includes('resumo') || lowerTranscript.includes('tarefas') || lowerTranscript.includes('como estou')) {
          this.showDailySummary();
        } else if (lowerTranscript.includes('registrar atividades por voz') || lowerTranscript.includes('registrar por voz')) {
          this.startVoiceRegistration();
        } else if (lowerTranscript.includes('registrar atividade') || lowerTranscript.includes('adicionar atividade')) {
          this.openRegisterModal();
        } else if (lowerTranscript.includes('registrar atividades de ontem') || lowerTranscript.includes('atividades de ontem')) {
          this.openYesterdayModal();
        } else if (lowerTranscript.includes('edital') || lowerTranscript.includes('progresso')) {
          this.showEditalMenu();
        } else if (lowerTranscript.includes('simulado') || lowerTranscript.includes('nota')) {
          this.showSimuladosMenu();
        } else if (lowerTranscript.includes('programar simulado') || lowerTranscript.includes('agendar simulado')) {
          this.showSimuladoModal();
        } else if (lowerTranscript.includes('relatório') || lowerTranscript.includes('gerar relatório')) {
          this.showRelatorioModal();
        } else if (lowerTranscript.includes('trocar baralhos') || lowerTranscript.includes('mudar baralhos')) {
          this.trocarBaralhos();
        } else if (lowerTranscript.includes('configurar') || lowerTranscript.includes('configurações')) {
          this.showConfigModal();
        } else if (lowerTranscript.includes('ajuda') || lowerTranscript.includes('comandos')) {
          this.showVoiceCommandsModal();
        } else if (lowerTranscript.includes('reset') || lowerTranscript.includes('reiniciar')) {
          this.showResetConfirmation();
        } else if (lowerTranscript.includes('parar') || lowerTranscript.includes('cancelar')) {
          this.stopVoiceRecognition();
          this.showVoiceFeedback('Reconhecimento de voz interrompido');
        } else if (this.voiceRegistrationActive) {
          // Processar comandos de registro automático
          this.processVoiceRegistration(transcript, lowerTranscript);
        } else {
          // Comando não reconhecido
          this.typeMessage("Não entendi seu comando. Tente dizer 'ajuda' para ver os comandos disponíveis.", this.narrationEnabled);
        }
      }
      
      // NOVO: Iniciar registro por voz
      startVoiceRegistration() {
        if (this.recognition && !this.isListening) {
          this.voiceRegistrationActive = true;
          this.showVoiceFeedback("Diga as atividades que você realizou. Exemplo: 'Divisão proporcional, 20 questões feitas, 2 erradas, 30 minutos'");
          
          try {
            this.recognition.start();
          } catch (error) {
            console.error('Erro ao iniciar reconhecimento:', error);
            this.showVoiceFeedback('Erro ao iniciar microfone');
          }
        }
      }
      
      // NOVO: Processar comandos de registro automático
      processVoiceRegistration(transcript, lowerTranscript) {
        // Parar o reconhecimento após processar o comando
        this.stopVoiceRecognition();
        this.voiceRegistrationActive = false;
        
        // Processar a fala para extrair atividades
        const activities = this.parseVoiceActivities(transcript);
        
        if (activities.length > 0) {
          this.registerVoiceActivities(activities);
        } else {
          this.showVoiceFeedback("Não consegui identificar atividades na sua fala. Tente novamente.");
          this.typeMessage("Não consegui identificar atividades na sua fala. Tente um formato como: 'Divisão proporcional, 20 questões feitas, 2 erradas, 30 minutos'", false);
        }
      }
      
      // NOVO: Função para analisar e extrair atividades da fala
      parseVoiceActivities(transcript) {
        const activities = [];
        
        // Dividir por possíveis separadores
        const activityStrings = transcript.split(/ e | depois | em seguida |\. |, /i);
        
        activityStrings.forEach(activityStr => {
          if (activityStr.trim()) {
            const activity = this.parseSingleActivity(activityStr.trim());
            if (activity) {
              activities.push(activity);
            }
          }
        });
        
        return activities;
      }
      
      // NOVO: Função para analisar uma única atividade
      parseSingleActivity(activityStr) {
        const lowerStr = activityStr.toLowerCase();
        
        // Tentar identificar o tipo de atividade e extrair informações
        let activity = null;
        
        // Padrão para questões: "assunto, X questões feitas, Y erradas, Z minutos"
        const questaoMatch = activityStr.match(/(.+?),\s*(\d+)\s*questões?\s*feitas?,\s*(\d+)\s*erradas?,\s*(\d+)\s*minutos?/i);
        if (questaoMatch) {
          activity = {
            type: 'questoes',
            assunto: questaoMatch[1].trim(),
            feitas: parseInt(questaoMatch[2]),
            erradas: parseInt(questaoMatch[3]),
            tempo: parseInt(questaoMatch[4])
          };
        }
        
        // Padrão para teoria: "matéria, progresso [conteúdo], X minutos"
        const teoriaMatch = activityStr.match(/(.+?),\s*progresso\s*(.+?),\s*(\d+)\s*minutos?/i);
        if (teoriaMatch && !activity) {
          activity = {
            type: 'teoria',
            materia: teoriaMatch[1].trim(),
            conteudo: teoriaMatch[2].trim(),
            tempo: parseInt(teoriaMatch[3])
          };
        }
        
        // Padrão para ANKI: "assunto, X minutos, Y cards"
        const ankiMatch = activityStr.match(/(.+?),\s*(\d+)\s*minutos?,\s*(\d+)\s*cards?/i);
        if (ankiMatch && !activity) {
          activity = {
            type: 'anki',
            deck: ankiMatch[1].trim(),
            tempo: parseInt(ankiMatch[2]),
            cards: parseInt(ankiMatch[3])
          };
        }
        
        // Padrão genérico para teoria: "matéria, X minutos"
        const teoriaSimpleMatch = activityStr.match(/(.+?),\s*(\d+)\s*minutos?/i);
        if (teoriaSimpleMatch && !activity) {
          activity = {
            type: 'teoria',
            materia: teoriaSimpleMatch[1].trim(),
            conteudo: 'Estudo por voz',
            tempo: parseInt(teoriaSimpleMatch[2])
          };
        }
        
        return activity;
      }
      
      // NOVO: Função para registrar atividades por voz
      registerVoiceActivities(activities) {
        const hoje = new Date();
        const hojeStr = hoje.toISOString().split('T')[0];
        
        let savedCount = 0;
        let totalTime = 0;
        let activitiesData = {
          questoes: [],
          anki: [],
          teoria: []
        };
        
        activities.forEach(activity => {
          try {
            if (activity.type === 'questoes') {
              this.saveQuestoes(activity.assunto, activity.feitas, activity.erradas, activity.tempo, hojeStr);
              activitiesData.questoes.push({
                assunto: activity.assunto,
                feitas: activity.feitas,
                erradas: activity.erradas,
                tempo: activity.tempo
              });
              savedCount++;
              totalTime += activity.tempo;
            } else if (activity.type === 'teoria') {
              this.saveTeoria(activity.materia, activity.conteudo, '', activity.tempo, hojeStr);
              activitiesData.teoria.push({
                materia: activity.materia,
                conteudo: activity.conteudo,
                tempo: activity.tempo
              });
              savedCount++;
              totalTime += activity.tempo;
            } else if (activity.type === 'anki') {
              this.saveAnki(activity.deck, activity.tempo, activity.cards, hojeStr);
              activitiesData.anki.push({
                deck: activity.deck,
                tempo: activity.tempo,
                cards: activity.cards
              });
              savedCount++;
              totalTime += activity.tempo;
            }
          } catch (error) {
            console.error('Erro ao salvar atividade por voz:', error);
          }
        });
        
        // Salvar as atividades do dia
        if (savedCount > 0) {
          const dailyActivities = {
            date: hojeStr,
            activities: activitiesData
          };
          localStorage.setItem('dailyActivities', JSON.stringify(dailyActivities));
          localStorage.setItem('lastRegisterDate', hojeStr);
          
          this.showRegistrationSummary(savedCount, totalTime, activitiesData);
          this.showVoiceFeedback(`${savedCount} atividades registradas com sucesso!`);
        } else {
          this.showVoiceFeedback("Nenhuma atividade foi registrada.");
        }
      }
      
      // NOVO: Iniciar reconhecimento de voz
      startVoiceRecognition() {
        if (this.recognition && !this.isListening) {
          try {
            this.recognition.start();
          } catch (error) {
            console.error('Erro ao iniciar reconhecimento:', error);
            this.showVoiceFeedback('Erro ao iniciar microfone');
          }
        }
      }
      
      // NOVO: Parar reconhecimento de voz
      stopVoiceRecognition() {
        if (this.recognition && this.isListening) {
          this.recognition.stop();
        }
      }
      
      // NOVO: Falar texto
      speakText(text) {
        if (this.synthesis && text && this.narrationEnabled) {
          // Parar qualquer fala em andamento
          this.synthesis.cancel();
          
          // Mudar avatar para estado falando
          this.mudarEstadoAvatar('falando');
          
          const utterance = new SpeechSynthesisUtterance(text);
          
          // Configurar voz (preferir voz em português)
          if (this.voices.length > 0) {
            const portugueseVoice = this.voices.find(voice => 
              voice.lang.includes('pt') || voice.lang.includes('PT')
            );
            if (portugueseVoice) {
              utterance.voice = portugueseVoice;
            }
          }
          
          utterance.rate = 0.9;
          utterance.pitch = 1;
          utterance.volume = 0.8;
          
          // Quando a fala terminar, voltar o avatar ao estado parado
          utterance.onend = () => {
            this.mudarEstadoAvatar('parado');
          };
          
          this.synthesis.speak(utterance);
        }
      }
      
      // NOVO: Mostrar modal de comandos de voz
      showVoiceCommandsModal() {
        document.getElementById('voiceCommandsModal').style.display = 'flex';
      }
      
      // NOVO: Fechar modal de comandos de voz
      closeVoiceCommandsModal() {
        document.getElementById('voiceCommandsModal').style.display = 'none';
      }
      
      initEventListeners() {
        // Toggle de tema
        document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());
        
        // NOVO: Toggle de narração
        document.getElementById('narrationToggle').addEventListener('click', () => this.toggleNarration());
        
        // Botão de info
        document.getElementById('infoBtn').addEventListener('click', () => this.showInfo());
        
        // Botão de comandos de voz
        document.getElementById('voiceCommandsBtn').addEventListener('click', () => this.showVoiceCommandsModal());
        
        // Enviar mensagem
        document.getElementById('sendMessage').addEventListener('click', () => this.sendMessage());
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.sendMessage();
          }
        });
        
        // Botões de ação rápida
        document.getElementById('attachBtn').addEventListener('click', () => this.showQuickActions());
        document.getElementById('emojiBtn').addEventListener('click', () => this.toggleEmojiPicker());
        
        // Botão de microfone
        document.getElementById('microphoneBtn').addEventListener('click', () => {
          if (this.isListening) {
            this.stopVoiceRecognition();
          } else {
            this.startVoiceRecognition();
          }
        });
        
        // Modal de registro
        document.getElementById('closeRegisterModal').addEventListener('click', () => this.closeRegisterModal());
        document.getElementById('cancelRegister').addEventListener('click', () => this.closeRegisterModal());
        document.getElementById('saveRegister').addEventListener('click', () => this.saveSelectedTasks());
        
        // NOVO: Modal de registro de ontem
        document.getElementById('closeYesterdayModal').addEventListener('click', () => this.closeYesterdayModal());
        document.getElementById('cancelYesterday').addEventListener('click', () => this.closeYesterdayModal());
        document.getElementById('saveYesterday').addEventListener('click', () => this.saveYesterdayTasks());
        
        // Modal de configuração
        document.getElementById('closeConfigModal').addEventListener('click', () => this.closeConfigModal());
        document.getElementById('cancelConfig').addEventListener('click', () => this.closeConfigModal());
        document.getElementById('saveConfig').addEventListener('click', () => this.saveConfig());
        
        // Modal de simulado
        document.getElementById('closeSimuladoModal').addEventListener('click', () => this.closeSimuladoModal());
        document.getElementById('cancelSimulado').addEventListener('click', () => this.closeSimuladoModal());
        document.getElementById('saveSimulado').addEventListener('click', () => this.saveSimuladoConfig());
        
        // Modal de relatório
        document.getElementById('closeRelatorioModal').addEventListener('click', () => this.closeRelatorioModal());
        document.getElementById('cancelRelatorio').addEventListener('click', () => this.closeRelatorioModal());
        document.getElementById('generateRelatorio').addEventListener('click', () => this.generateRelatorio());
        
        // Modal de comandos de voz
        document.getElementById('closeVoiceCommandsModal').addEventListener('click', () => this.closeVoiceCommandsModal());
        document.getElementById('closeVoiceCommandsModalBtn').addEventListener('click', () => this.closeVoiceCommandsModal());
        
        // Fechar modal ao clicar fora
        window.addEventListener('click', (e) => {
          const registerModal = document.getElementById('registerModal');
          const yesterdayModal = document.getElementById('yesterdayModal');
          const configModal = document.getElementById('configModal');
          const simuladoModal = document.getElementById('simuladoModal');
          const relatorioModal = document.getElementById('relatorioModal');
          const voiceCommandsModal = document.getElementById('voiceCommandsModal');
          
          if (e.target === registerModal) {
            this.closeRegisterModal();
          }
          if (e.target === yesterdayModal) {
            this.closeYesterdayModal();
          }
          if (e.target === configModal) {
            this.closeConfigModal();
          }
          if (e.target === simuladoModal) {
            this.closeSimuladoModal();
          }
          if (e.target === relatorioModal) {
            this.closeRelatorioModal();
          }
          if (e.target === voiceCommandsModal) {
            this.closeVoiceCommandsModal();
          }
        });
      }
      
      showWelcomeMessage() {
        if (this.chatHistory.length === 0) {
          // Adicionar data atual
          this.addDateDivider();
          this.typeMessage("Olá! Sou seu assistente de estudos do StudyFlow. 👋", this.narrationEnabled, () => {
            setTimeout(() => {
              this.typeMessage("Posso te ajudar a gerenciar seu ciclo de estudos, mostrar tarefas diárias, registrar progresso e muito mais!", this.narrationEnabled, () => {
                setTimeout(() => {
                  this.addQuickActions();
                }, 500);
              });
            }, 500);
          });
        }
      }
      
      addQuickActions() {
        const quickActionsHTML = `
          <div class="quick-actions">
            <button class="action-btn primary" onclick="chatBot.showDailySummary()">
              <i class="fas fa-calendar-day"></i> Resumo do Dia
            </button>
            <button class="action-btn secondary" onclick="chatBot.openRegisterModal()">
              <i class="fas fa-plus-circle"></i> Registrar Atividade
            </button>
            <!-- NOVO BOTÃO: Registrar Atividades por Voz -->
            <button class="action-btn info" onclick="chatBot.startVoiceRegistration()">
              <i class="fas fa-microphone-alt"></i> Registrar atividades por voz
            </button>
            <!-- NOVO BOTÃO: Registrar Atividades do Dia Anterior -->
            <button class="action-btn info" onclick="chatBot.openYesterdayModal()">
              <i class="fas fa-history"></i> Registrar Atividades de Ontem
            </button>
            <button class="action-btn info" onclick="chatBot.showEditalMenu()">
              <i class="fas fa-file-alt"></i> Edital
            </button>
            <button class="action-btn info" onclick="chatBot.showSimuladosMenu()">
              <i class="fas fa-chart-line"></i> Simulados
            </button>
            <button class="action-btn info" onclick="chatBot.showSimuladoModal()">
              <i class="fas fa-calendar-alt"></i> Programar Simulado
            </button>
            <button class="action-btn info" onclick="chatBot.showRelatorioModal()">
              <i class="fas fa-chart-bar"></i> Relatório
            </button>
            <button class="action-btn info" onclick="chatBot.trocarBaralhos()">
              <i class="fas fa-sync-alt"></i> Trocar Baralhos
            </button>
            <button class="action-btn info" onclick="chatBot.showConfigModal()">
              <i class="fas fa-cog"></i> Configurar
            </button>
            <button class="action-btn info" onclick="chatBot.showVoiceCommandsModal()">
              <i class="fas fa-microphone-alt"></i> Comandos de Voz
            </button>
            <button class="action-btn info" onclick="chatBot.showHelp()">
              <i class="fas fa-question-circle"></i> Ajuda
            </button>
            <button class="action-btn reset" onclick="chatBot.showResetConfirmation()">
              <i class="fas fa-exclamation-triangle"></i> Reset
            </button>
          </div>
        `;
        this.addBotMessage(quickActionsHTML, false);
      }
      
      // NOVA FUNÇÃO: Atualizar memória temporária do dia anterior
      updateYesterdayMemory() {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        // Verificar se já existe registro para ontem
        const yesterdayActivities = JSON.parse(localStorage.getItem(`dailyActivities_${yesterdayStr}`)) || { activities: {} };
        
        // Se não há atividades registradas para ontem, atualizar a memória temporária
        if (!yesterdayActivities.activities || Object.keys(yesterdayActivities.activities).length === 0) {
          // Verificar se já temos tarefas na memória para ontem
          if (!this.yesterdayMemory.date || this.yesterdayMemory.date !== yesterdayStr) {
            // Buscar tarefas de ontem para preencher a memória temporária
            const yesterdayTasks = this.getTodayTasks(yesterdayStr);
            this.yesterdayMemory = {
              activities: yesterdayTasks,
              date: yesterdayStr
            };
            localStorage.setItem('studyFlow_yesterdayMemory', JSON.stringify(this.yesterdayMemory));
          }
        } else {
          // Se já tem atividades registradas, limpar a memória temporária
          this.yesterdayMemory = {
            activities: {},
            date: null
          };
          localStorage.setItem('studyFlow_yesterdayMemory', JSON.stringify(this.yesterdayMemory));
        }
      }
      
      // NOVA FUNÇÃO: Abrir modal para registrar atividades de ontem
      openYesterdayModal() {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        // Verificar se já registrou atividades para ontem
        const yesterdayActivities = JSON.parse(localStorage.getItem(`dailyActivities_${yesterdayStr}`)) || { activities: {} };
        if (yesterdayActivities.activities && Object.keys(yesterdayActivities.activities).length > 0) {
          this.typeMessage("Você já registrou atividades para ontem! 😊", this.narrationEnabled);
          return;
        }
        
        // Verificar se há atividades na memória temporária
        if (!this.yesterdayMemory.activities || 
            (this.yesterdayMemory.activities.questoes.length === 0 && 
             this.yesterdayMemory.activities.anki.length === 0 && 
             this.yesterdayMemory.activities.teoria.length === 0)) {
          this.typeMessage("Não há atividades pendentes para ontem. 😊", this.narrationEnabled);
          return;
        }
        
        document.getElementById('yesterdayModal').style.display = 'flex';
        this.loadYesterdayTasks();
      }
      
      // NOVA FUNÇÃO: Carregar tarefas de ontem no modal
      loadYesterdayTasks() {
        const modalBody = document.getElementById('yesterdayModalBody');
        modalBody.innerHTML = '';
        
        if (!this.yesterdayMemory.activities || 
            (this.yesterdayMemory.activities.questoes.length === 0 && 
             this.yesterdayMemory.activities.anki.length === 0 && 
             this.yesterdayMemory.activities.teoria.length === 0)) {
          modalBody.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-check-circle"></i>
              <h3>Não há tarefas pendentes para ontem!</h3>
              <p>Não foram encontradas atividades não registradas de ontem.</p>
            </div>
          `;
          return;
        }
        
        let tasksHTML = '<div class="tasks-grid">';
        
        // Adicionar cards para questões
        this.yesterdayMemory.activities.questoes.forEach(questao => {
          tasksHTML += this.createQuestaoCard(questao);
        });
        
        // Adicionar cards para Anki
        this.yesterdayMemory.activities.anki.forEach(deck => {
          tasksHTML += this.createAnkiCard(deck);
        });
        
        // Adicionar cards para teoria
        this.yesterdayMemory.activities.teoria.forEach(materia => {
          tasksHTML += this.createTeoriaCard(materia);
        });
        
        tasksHTML += '</div>';
        modalBody.innerHTML = tasksHTML;
      }
      
      // CORREÇÃO CRÍTICA APLICADA: Salvar atividades de ontem - AGORA REGISTRA COM A DATA CORRETA DE ONTEM
      // CORREÇÃO: As atividades são salvas com a data real do dia anterior, não com a data atual
      saveYesterdayTasks() {
        const activeCards = document.querySelectorAll('#yesterdayModal .task-card.active');
        let hasError = false;
        let savedCount = 0;
        let totalTime = 0;
        let activities = {
          questoes: [],
          anki: [],
          teoria: []
        };
        
        if (activeCards.length === 0) {
          alert('Por favor, selecione pelo menos uma atividade para registrar.');
          return;
        }
        
        // CORREÇÃO APLICADA: Obter a data de ontem corretamente
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        activeCards.forEach(card => {
          const type = card.getAttribute('data-type');
          const id = card.getAttribute('data-id');
          
        if (type === 'questoes') {
            const feitas = document.getElementById(`questoes-feitas-${id}`).value;
            const erradas = document.getElementById(`questoes-erradas-${id}`).value;
            const tempo = document.getElementById(`questoes-tempo-${id}`).value;
            
            if (!feitas || !tempo) {
              hasError = true;
              card.style.border = '1px solid red';
            } else {
              card.style.border = '';
              // CORREÇÃO APLICADA: Chamar a função de salvamento para questões com data de ontem
              this.saveQuestoes(id, feitas, erradas, tempo, yesterdayStr);
              savedCount++;
              totalTime += parseInt(tempo);
              activities.questoes.push({
                assunto: id,
                feitas: parseInt(feitas),
                erradas: parseInt(erradas),
                tempo: parseInt(tempo)
              });
            }
          } else if (type === 'anki') {
            const tempo = document.getElementById(`anki-tempo-${id}`).value;
            const cards = document.getElementById(`anki-cards-${id}`).value;
            
            if (!tempo || !cards) {
              hasError = true;
              card.style.border = '1px solid red';
            } else {
              card.style.border = '';
              // CORREÇÃO APLICADA: Chamar a função de salvamento para Anki com data de ontem
              this.saveAnki(id, tempo, cards, yesterdayStr);
              savedCount++;
              totalTime += parseInt(tempo);
              activities.anki.push({
                deck: id,
                tempo: parseInt(tempo),
                cards: parseInt(cards)
              });
            }
          } else if (type === 'teoria') {
            const conteudo = document.getElementById(`teoria-conteudo-${id}`).value;
            const pagina = document.getElementById(`teoria-pagina-${id}`).value;
            const tempo = document.getElementById(`teoria-tempo-${id}`).value;
            
            if (!tempo) {
              hasError = true;
              card.style.border = '1px solid red';
            } else {
              card.style.border = '';
              // CORREÇÃO APLICADA: Chamar a função de salvamento para teoria com data de ontem
              this.saveTeoria(id, conteudo, pagina, tempo, yesterdayStr);
              savedCount++;
              totalTime += parseInt(tempo);
              activities.teoria.push({
                materia: id,
                conteudo: conteudo,
                pagina: pagina,
                tempo: parseInt(tempo)
              });
            }
          }
        });
        
        if (hasError) {
          alert('Preencha todos os campos obrigatórios das atividades selecionadas!');
          return;
        }
        
        // CORREÇÃO APLICADA: Salvar as atividades do dia anterior com a data correta de ontem
        const dailyActivities = {
          date: yesterdayStr, // DATA REAL DO DIA ANTERIOR
          activities: activities
        };
        localStorage.setItem(`dailyActivities_${yesterdayStr}`, JSON.stringify(dailyActivities));
        
        // Limpar a memória temporária
        this.yesterdayMemory = {
          activities: {},
          date: null
        };
        localStorage.setItem('studyFlow_yesterdayMemory', JSON.stringify(this.yesterdayMemory));
        
        this.closeYesterdayModal();
        
        if (savedCount > 0) {
          this.showRegistrationSummary(savedCount, totalTime, activities, true);
        }
      }
      
      // NOVA FUNÇÃO: Fechar modal de ontem
      closeYesterdayModal() {
        document.getElementById('yesterdayModal').style.display = 'none';
      }
      
      // NOVA FUNÇÃO: Obter tarefas para uma data específica
      getTodayTasks(dateStr = null) {
        const date = dateStr ? new Date(dateStr + 'T00:00:00') : new Date();
        const dateKey = dateStr || this.getDynamicDateString();
        
        const tasks = {
          questoes: [],
          anki: [],
          teoria: []
        };
        
        // Buscar assuntos para questões (revisão)
        tasks.questoes = this.calculateTodayReviews(date);
        
        // Buscar baralhos do Anki
        tasks.anki = this.getTodayDecks().map(deckName => ({
          id: deckName,
          nome: deckName,
          emoji: '🔁'
        }));
        
        // Buscar matérias de teoria (ciclo teórico)
        const activeCycle = this.getActiveCycle();
        if (activeCycle && activeCycle.generatedCycle) {
          tasks.teoria = this.getTodaySubjects(date);
        }
        
        return tasks;
      }
      
      // FUNÇÃO ATUALIZADA: Incluir botão para registrar atividades de ontem no resumo do dia
      showDailySummary() {
        const hoje = this.getDynamicDateObject();
        const hojeStr = this.getDynamicDateString();
        
        // Verificar se hoje é dia de simulado
        this.checkSimuladoDay();
        
        // Atualizar automaticamente os baralhos do Anki
        this.updateAnkiProgress();
        
        // Verificar se já registrou atividades HOJE
        if (this.hasStudiedToday()) {
          // Já registrou hoje - mostrar resumo do que foi feito
          this.showTodaySummary(hojeStr);
        } else {
          // Não registrou hoje - mostrar tarefas pendentes
          this.showPendingTasks(hojeStr);
        }
        
        // NOVO: Adicionar botão para registrar atividades de ontem se aplicável
        this.addYesterdayButtonIfNeeded();
      }
      
      // NOVA FUNÇÃO: Adicionar botão para registrar atividades de ontem se necessário
      addYesterdayButtonIfNeeded() {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        // Verificar se há atividades não registradas para ontem
        const yesterdayActivities = JSON.parse(localStorage.getItem(`dailyActivities_${yesterdayStr}`)) || { activities: {} };
        
        if (!yesterdayActivities.activities || Object.keys(yesterdayActivities.activities).length === 0) {
          // Verificar se há atividades na memória temporária
          if (this.yesterdayMemory.activities && 
              (this.yesterdayMemory.activities.questoes.length > 0 || 
               this.yesterdayMemory.activities.anki.length > 0 || 
               this.yesterdayMemory.activities.teoria.length > 0)) {
            
            setTimeout(() => {
              this.addBotMessage(`
                <div class="message-alert message-alert-warning">
                  <i class="fas fa-history"></i>
                  <div><strong>Você tem atividades não registradas de ontem!</strong></div>
                </div>
                <div class="quick-actions">
                  <button class="action-btn info" onclick="chatBot.openYesterdayModal()">
                    <i class="fas fa-history"></i> Registrar Atividades de Ontem
                  </button>
                </div>
              `, false);
            }, 1000);
          }
        }
      }
      
      // CORREÇÃO APLICADA: Funções de salvamento atualizadas para aceitar data específica
      // CORREÇÃO: As funções agora podem receber uma data específica para salvar as atividades
      
      saveQuestoes(assuntoId, feitas, erradas, tempo, specificDate = null) {
        const corretas = parseInt(feitas) - parseInt(erradas);
        const dificuldade = 2; // Valor padrão (Bom) - poderia ser capturado do usuário
        
        // Atualizar módulo de revisões
        const revisaoAtualizada = this.updateReviewModule(assuntoId, feitas, corretas, tempo, dificuldade, specificDate);
        
        if (revisaoAtualizada) {
          // Atualizar módulo home (mantendo o funcionamento atual)
          let dailyCompletedReviews = this.getModuleData('dailyCompletedReviews') || 0;
          dailyCompletedReviews += 1;
          this.setModuleData('dailyCompletedReviews', dailyCompletedReviews);
          
          const hoje = specificDate ? new Date(specificDate + 'T00:00:00') : new Date();
          this.setModuleData('lastReviewDate', hoje.toISOString().split('T')[0]);
          
          this.registerHomeSession(`Questões - ${assuntoId}`, parseInt(tempo), specificDate);
          localStorage.setItem('ultimoEstudo', new Date().toISOString());
        }
      }
      
      saveTeoria(materiaId, conteudo, pagina, tempo, specificDate = null) {
        // Atualizar ciclo de estudos
        const cicloAtualizado = this.updateStudyCycle(materiaId, tempo, specificDate);
        
        if (cicloAtualizado) {
          // Registrar sessão no módulo Home (mantendo o funcionamento atual)
          this.registerHomeSession(`Teoria - ${materiaId}`, parseInt(tempo), specificDate);
          
          // Salvar progresso da teoria
          const teoriaProgress = this.getModuleData('teoriaProgress') || {};
          teoriaProgress[materiaId] = {
            conteudo: conteudo,
            pagina: pagina,
            ultimaAtualizacao: new Date().toISOString()
          };
          this.setModuleData('teoriaProgress', teoriaProgress);
          
          localStorage.setItem('ultimoEstudo', new Date().toISOString());
        }
      }
      
      saveAnki(deckId, tempo, cards, specificDate = null) {
        // Registrar sessão no módulo Home
        const ankiData = this.getModuleData('ciclos_focus_v1');
        const deck = ankiData && ankiData.decks ? ankiData.decks.find(d => d.id === deckId) : null;
        const deckNome = deck ? deck.name : deckId;
        
        this.registerHomeSession(`Anki - ${deckNome}`, parseInt(tempo), specificDate);
        
        // Atualizar último estudo
        localStorage.setItem('ultimoEstudo', new Date().toISOString());
      }
      
      // CORREÇÃO APLICADA: Função registerHomeSession atualizada para aceitar data específica
      registerHomeSession(subject, minutes, specificDate = null) {
        const date = specificDate ? new Date(specificDate + 'T00:00:00') : new Date();
        const dateKey = `sessions-${date.getDate()}-${date.getMonth()+1}-${date.getFullYear()}`;
        
        let sessions = this.getModuleData(dateKey) || [];
        sessions.push({
          subject: subject,
          minutes: minutes,
          date: `${date.getDate()}-${date.getMonth()+1}-${date.getFullYear()}`,
          timestamp: date.toISOString()
        });
        
        this.setModuleData(dateKey, sessions);
      }
      
      // CORREÇÃO APLICADA: Função updateReviewModule atualizada para aceitar data específica
      updateReviewModule(assuntoId, feitas, corretas, tempo, dificuldade, specificDate = null) {
        const disciplines = this.getModuleData('disciplines') || [];
        const reviewDate = specificDate ? new Date(specificDate + 'T00:00:00') : new Date();
        const reviewTimestamp = reviewDate.getTime();
        
        // Encontrar o assunto específico
        let assuntoEncontrado = null;
        let disciplinaEncontrada = null;
        
        for (const disciplina of disciplines) {
          if (disciplina.assuntos && Array.isArray(disciplina.assuntos)) {
            for (const assunto of disciplina.assuntos) {
              if (assunto.nome === assuntoId) {
                assuntoEncontrado = assunto;
                disciplinaEncontrada = disciplina;
                break;
              }
            }
            if (assuntoEncontrado) break;
          }
        }
        
        if (assuntoEncontrado) {
          // Atualizar estatísticas
          assuntoEncontrado.questions = (assuntoEncontrado.questions || 0) + parseInt(feitas);
          assuntoEncontrado.correct = (assuntoEncontrado.correct || 0) + parseInt(corretas);
          assuntoEncontrado.incorrect = (assuntoEncontrado.incorrect || 0) + (parseInt(feitas) - parseInt(corretas));
          
          // Adicionar dificuldade ao histórico
          if (!assuntoEncontrado.difficultyHistory) {
            assuntoEncontrado.difficultyHistory = [];
          }
          assuntoEncontrado.difficultyHistory.push(parseInt(dificuldade));
          
          // Calcular acurácia
          const accuracy = (parseInt(corretas) / parseInt(feitas)) * 100;
          
          // Determinar o método de revisão
          if (assuntoEncontrado.reviewMethod === 'fixed') {
            // Revisão por desempenho - usar a função do módulo de revisões
            const interval = this.getPerformanceBasedInterval(accuracy);
            assuntoEncontrado.interval = interval;
            assuntoEncontrado.repetitions = (assuntoEncontrado.repetitions || 0) + 1;
          } else {
            // SM-2 - usar a função do módulo de revisões
            const result = this.calculateNextReviewSM2(
              parseInt(dificuldade),
              assuntoEncontrado.easeFactor || 2.5,
              assuntoEncontrado.interval || 1,
              assuntoEncontrado.repetitions || 0
            );
            assuntoEncontrado.easeFactor = result.newEF;
            assuntoEncontrado.interval = result.newInterval;
            assuntoEncontrado.repetitions = result.repetitions;
          }
          
          // CORREÇÃO APLICADA: Usar a data específica fornecida
          assuntoEncontrado.lastReviewed = reviewTimestamp;
          
          // Calcular próxima data de revisão
          const nextReviewDate = new Date(reviewTimestamp);
          nextReviewDate.setDate(nextReviewDate.getDate() + assuntoEncontrado.interval);
          assuntoEncontrado.nextReviewDate = nextReviewDate.getTime();
          
          // Calcular força da memória
          assuntoEncontrado.memoryStrength = this.calculateMemoryStrength(assuntoEncontrado);
          
          // Salvar de volta no localStorage
          this.setModuleData('disciplines', disciplines);
          return true;
        } else {
          return false;
        }
      }
      
      // CORREÇÃO APLICADA: Função updateStudyCycle atualizada para aceitar data específica
      updateStudyCycle(materiaId, tempo, specificDate = null) {
        const activeCycle = this.getActiveCycle();
        // CORREÇÃO: Usar a data específica fornecida ou a data atual
        const studyDate = specificDate || new Date().toISOString().split('T')[0];
        
        if (activeCycle && activeCycle.generatedCycle) {
          const todayIndex = activeCycle.currentDay || 0;
          const cycleLength = activeCycle.generatedCycle.length;
          
          // Encontrar a matéria no ciclo atual
          let materiaEncontrada = activeCycle.generatedCycle[todayIndex % cycleLength];
          
          // Se for um array (múltiplas matérias no mesmo dia), verificar se a matéria está presente
          if (Array.isArray(materiaEncontrada)) {
            if (materiaEncontrada.includes(materiaId)) {
              materiaEncontrada = materiaId;
            } else {
              materiaEncontrada = null;
            }
          } else {
            if (materiaEncontrada !== materiaId) {
              materiaEncontrada = null;
            }
          }
          
          if (materiaEncontrada) {
            // Marcar como estudada no dia atual
            if (!activeCycle.completedSubjects) {
              activeCycle.completedSubjects = {};
            }
            activeCycle.completedSubjects[todayIndex] = true;
            
            // CORREÇÃO APLICADA: Usar a data específica fornecida
            // Avançar para o próximo dia apenas se ainda não avançou no dia específico
            if (activeCycle.lastAdvanced !== studyDate) {
              activeCycle.currentDay = (todayIndex + 1) % cycleLength;
              activeCycle.lastAdvanced = studyDate;
            }
            
            // Atualizar estatísticas de progresso
            if (!activeCycle.studyTime) {
              activeCycle.studyTime = {};
            }
            // CORREÇÃO APLICADA: Usar a data específica fornecida como chave
            activeCycle.studyTime[studyDate] = (activeCycle.studyTime[studyDate] || 0) + parseInt(tempo);
            
            // Salvar de volta
            this.setModuleData('StudyFlow_activeCycle', activeCycle);
            return true;
          }
        }
        return false;
      }
      
      // FUNÇÃO ATUALIZADA: Reset para módulo Chatbot 
      showResetConfirmation() { 
        const confirmationHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-exclamation-triangle" style="color: var(--danger)"></i> 
              <div class="message-card-title">Reset Temporário</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-alert message-alert-danger"> 
                <i class="fas fa-exclamation-circle"></i> 
                <div><strong>Atenção!</strong> Esta função executa um reset temporário do módulo do Chatbot, útil para corrigir travamentos ou inconsistências nos dados do dia. Nenhum outro módulo será afetado. Deseja continuar?</div> 
              </div> 
              <div class="quick-actions"> 
                <button class="action-btn reset" onclick="chatBot.resetChatbotData()"> 
                  <i class="fas fa-sync-alt"></i> Confirmar Reset 
                </button> 
                <button class="action-btn info" onclick="chatBot.addBotMessage('Reset cancelado. O sistema permanece inalterado.', false)"> 
                  <i class="fas fa-times"></i> Cancelar 
                </button> 
              </div> 
            </div> 
          </div> 
        `; 
        this.addBotMessage(confirmationHTML, false); 
      } 
      
      // FUNÇÃO ATUALIZADA: Reset dos dados do chatbot 
      resetChatbotData() { 
        const hoje = new Date(); 
        const hojeStr = hoje.toLocaleDateString('pt-BR'); 
        
        // Limpar apenas os dados específicos do chatbot que estão bloqueando o dia 
        localStorage.removeItem('lastRegisterDate'); 
        localStorage.removeItem('dailyActivities'); 
        
        // Mensagem de confirmação 
        const successHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-check-circle" style="color: var(--success)"></i> 
              <div class="message-card-title">Reset Concluído</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-alert message-alert-success"> 
                <i class="fas fa-check-circle"></i> 
                <div><strong>Reset realizado com sucesso!</strong> Dados do módulo Chatbot reiniciados em ${hojeStr}.</div> 
              </div> 
              <div class="message-text"> 
                Agora você pode visualizar e registrar as atividades reais do dia. O sistema voltará a funcionar normalmente a partir de amanhã. 
              </div> 
              <div class="quick-actions"> 
                <button class="action-btn primary" onclick="chatBot.showDailySummary()"> 
                  <i class="fas fa-calendar-day"></i> Ver Resumo do Dia 
                </button> 
                <button class="action-btn secondary" onclick="chatBot.openRegisterModal()"> 
                  <i class="fas fa-plus-circle"></i> Registrar Atividades 
                </button> 
              </div> 
            </div> 
          </div> 
        `; 
        this.addBotMessage(successHTML, false); 
      } 
      
      // CORREÇÃO PARA O PROBLEMA DA DATA - FUNÇÕES NOVAS 
      getDynamicDateString() { 
        // SEMPRE retorna a data atual do sistema 
        const hoje = new Date(); 
        const year = hoje.getFullYear(); 
        const month = String(hoje.getMonth() + 1).padStart(2, '0'); 
        const day = String(hoje.getDate()).padStart(2, '0'); 
        return `${year}-${month}-${day}`; 
      } 
      
      getDynamicDateObject() { 
        // SEMPRE retorna o objeto Date atual 
        return new Date(); 
      } 
      
      formatDynamicDate(date) { 
        // Formata a data para exibição 
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; 
        return date.toLocaleDateString('pt-BR', options); 
      } 
      
      // CORREÇÃO APLICADA: Função para verificar se uma data é hoje 
      isToday(dateString) { 
        const hoje = this.getDynamicDateString(); 
        return dateString === hoje; 
      } 
      
      // CORREÇÃO APLICADA: Função para verificar se já registrou atividades HOJE 
      hasRegisteredToday() { 
        const lastRegisterDate = localStorage.getItem('lastRegisterDate'); 
        return lastRegisterDate && this.isToday(lastRegisterDate); 
      } 
      
      // NOVA FUNÇÃO: Verificar se já estudou hoje 
      hasStudiedToday() { 
        const dailyActivities = JSON.parse(localStorage.getItem('dailyActivities')) || {}; 
        return dailyActivities.date === this.today; 
      } 
      
      // MODIFICAR A FUNÇÃO showDailySummary (substituir a existente) 
      showDailySummary() { 
        const hoje = this.getDynamicDateObject(); // SEMPRE usa data dinâmica 
        const hojeStr = this.getDynamicDateString(); // SEMPRE usa data atual 
        
        // NOVO: Verificar se hoje é dia de simulado
        this.checkSimuladoDay();
        
        // Atualizar automaticamente os baralhos do Anki 
        this.updateAnkiProgress(); 
        
        // CORREÇÃO APLICADA: Verificar se já registrou atividades HOJE usando a nova função 
        if (this.hasStudiedToday()) { 
          // Já registrou hoje - mostrar resumo do que foi feito 
          this.showTodaySummary(hojeStr); 
        } else { 
          // Não registrou hoje - mostrar tarefas pendentes 
          this.showPendingTasks(hojeStr); 
        } 
      } 
      
      // NOVA FUNÇÃO: Verificar se hoje é dia de simulado
      checkSimuladoDay() {
        const simuladoConfig = JSON.parse(localStorage.getItem('studyFlow_simuladoConfig')) || {};
        
        if (simuladoConfig.interval && simuladoConfig.nextSimulado) {
          const hoje = new Date();
          const nextSimulado = new Date(simuladoConfig.nextSimulado);
          
          // Verificar se hoje é o dia do simulado
          if (hoje.toDateString() === nextSimulado.toDateString()) {
            this.addBotMessage(`
              <div class="message-alert message-alert-warning">
                <i class="fas fa-bullhorn"></i>
                <div><strong>Hoje é dia de simulado!</strong> Faça o simulado como se fosse o dia da prova real.</div>
              </div>
            `, false);
          }
        }
      }
      
      // NOVA FUNÇÃO: Atualizar progresso do Anki automaticamente 
      updateAnkiProgress() { 
        const ankiData = this.getModuleData('ciclos_focus_v1'); 
        if (!ankiData) return; 
        
        const today = new Date().toDateString(); 
        if (ankiData.lastUpdated !== today) { 
          // Atualizar o índice do Anki para o dia atual 
          const totalDecks = ankiData.decks.length; 
          const perDay = ankiData.perDay; 
          const totalBlocks = Math.ceil(totalDecks / perDay); 
          
          // Calcular o índice baseado na data 
          const startDate = new Date(ankiData.startDate || new Date()); 
          const diffTime = new Date() - startDate; 
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
          
          ankiData.blockIndex = diffDays % totalBlocks; 
          ankiData.lastUpdated = today; 
          this.setModuleData('ciclos_focus_v1', ankiData); 
        } 
      } 
      
      // MODIFICAR A FUNÇÃO showPendingTasks (substituir a existente) 
      showPendingTasks(hojeStr) { 
        const hoje = new Date(hojeStr + 'T00:00:00'); // Converte para objeto Date 
        const dataFormatada = this.formatDynamicDate(hoje); // Usa formatação dinâmica 
        
        // Buscar dados reais dos módulos 
        const dailyReviewGoal = this.getModuleData('dailyReviewGoal') || 5; 
        const dailyCompletedReviews = this.getModuleData('dailyCompletedReviews') || 0; 
        
        // Calcular revisões para hoje (usando o mesmo algoritmo do módulo de revisões) 
        const revisoesHoje = this.calculateTodayReviews(); 
        
        // Calcular progresso da meta diária 
        const progressoMeta = Math.min((dailyCompletedReviews / dailyReviewGoal) * 100, 100); 
        
        // Verificar alertas 
        const alertas = this.checkAlerts(); 
        
        // Obter matérias do ciclo - COM MÚLTIPLAS MATÉRIAS 
        const materiasCiclo = this.getTodaySubjects(); 
        
        // CORREÇÃO APLICADA: Obter baralhos do Anki ATUALIZADOS 
        const baralhosAnki = this.getTodayDecks(); 
        
        // Construir o card de resumo pendente com nova formatação 
        let summaryHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-calendar-day"></i> 
              <div class="message-card-title">Resumo do Dia - ${dataFormatada}</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-text"> 
                <strong>Olá! Aqui estão suas tarefas para hoje:</strong> 
              </div> 
        `; 
        
        // MODIFICAÇÃO APLICADA: REMOVIDA A SEÇÃO DE PROGRESSO DIÁRIO
        
        // Revisões 
        if (revisoesHoje.length > 0) { 
          summaryHTML += ` 
            <div class="message-section"> 
              <div class="message-section-title">Revisões Pendentes</div> 
              <div class="message-list"> 
          `; 
          revisoesHoje.forEach(revisao => { 
            summaryHTML += ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-book"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">${revisao.nome}</div> 
                    <div class="message-list-description">${revisao.disciplina}</div> 
                  </div> 
                </div> 
            `; 
          }); 
          summaryHTML += ` 
              </div> 
            </div> 
          `; 
        } else { 
          summaryHTML += ` 
            <div class="message-section"> 
              <div class="message-section-title">Revisões Pendentes</div> 
              <div class="message-alert message-alert-info"> 
                <i class="fas fa-info-circle"></i> 
                <div>Nenhuma revisão pendente para hoje</div> 
              </div> 
            </div> 
          `; 
        } 
        
        // Matérias - COM MÚLTIPLAS MATÉRIAS E HISTÓRICO 
        summaryHTML += ` 
          <div class="message-section"> 
            <div class="message-section-title">Matérias de Hoje</div> 
        `; 
        
        if (materiasCiclo.length > 0) { 
          summaryHTML += `<div class="message-list">`; 
          materiasCiclo.forEach(materia => { 
            // Buscar o progresso salvo para esta matéria 
            const teoriaProgress = this.getModuleData('teoriaProgress'); 
            const ultimoEstudo = teoriaProgress && teoriaProgress[materia]; 
            
            summaryHTML += ` 
              <div class="message-list-item"> 
                <div class="message-list-icon"><i class="fas fa-book"></i></div> 
                <div class="message-list-content"> 
                  <div class="message-list-title">${materia}</div> 
                  ${ultimoEstudo ? ` 
                    <div class="message-list-description"> 
                      Último estudo: ${ultimoEstudo.conteudo} ${ultimoEstudo.pagina ? `(${ultimoEstudo.pagina})` : ''} 
                    </div>` : ` 
                    <div class="message-list-description">Nenhum registro anterior</div>` 
                  } 
                </div> 
              </div> 
            `; 
          }); 
          summaryHTML += `</div>`; 
        } else { 
          summaryHTML += ` 
            <div class="message-alert message-alert-warning"> 
              <i class="fas fa-exclamation-triangle"></i> 
              <div>Nenhuma matéria encontrada no ciclo de estudos ativo</div> 
            </div> 
          `; 
        } 
        
        summaryHTML += `</div>`; 
        
        // Anki - CORREÇÃO APLICADA: Usar baralhos atualizados 
        summaryHTML += ` 
          <div class="message-section"> 
            <div class="message-section-title">Baralhos Anki</div> 
            <div class="message-list"> 
        `; 
        
        if (baralhosAnki.length > 0) { 
          baralhosAnki.forEach(deck => { 
            summaryHTML += ` 
              <div class="message-list-item"> 
                <div class="message-list-icon"><i class="fas fa-layer-group"></i></div> 
                <div class="message-list-content"> 
                  <div class="message-list-title">${deck}</div> 
                </div> 
              </div> 
            `; 
          }); 
        } else { 
          summaryHTML += ` 
            <div class="message-alert message-alert-info"> 
              <i class="fas fa-info-circle"></i> 
              <div>Nenhum baralho programado para hoje</div> 
            </div> 
          `; 
        } 
        
        summaryHTML += ` 
            </div> 
          </div> 
        `; 
        
        // Alertas 
        if (alertas.length > 0) { 
          summaryHTML += ` 
            <div class="message-section"> 
              <div class="message-section-title">Alertas</div> 
          `; 
          alertas.forEach(alerta => { 
            const alertClass = `message-alert-${alerta.tipo === 'alert-danger' ? 'danger' : alerta.tipo === 'alert-warning' ? 'warning' : 'info'}`; 
            summaryHTML += ` 
              <div class="message-alert ${alertClass}"> 
                <i class="fas fa-${alerta.icone}"></i> 
                <div>${alerta.mensagem}</div> 
              </div> 
            `; 
          }); 
          summaryHTML += `</div>`; 
        } 
        
        summaryHTML += ` 
            </div> 
          </div> 
        `; 
        
        this.addBotMessage(summaryHTML, true, 'pending-summary'); 
        
        // Adicionar botões de ação 
        setTimeout(() => { 
          this.addBotMessage(` 
            <div class="quick-actions"> 
              <button class="action-btn primary" onclick="chatBot.openRegisterModal()"> 
                <i class="fas fa-plus-circle"></i> Registrar Atividades 
              </button> 
              <!-- NOVO BOTÃO: Registrar Atividades por Voz -->
              <button class="action-btn info" onclick="chatBot.startVoiceRegistration()"> 
                <i class="fas fa-microphone-alt"></i> Registrar atividades por voz 
              </button> 
              <!-- NOVO BOTÃO: Trocar Baralhos -->
              <button class="action-btn info" onclick="chatBot.trocarBaralhos()"> 
                <i class="fas fa-sync-alt"></i> Trocar Baralhos 
              </button> 
              <button class="action-btn info" onclick="chatBot.showHelp()"> 
                <i class="fas fa-question-circle"></i> Preciso de Ajuda 
              </button> 
            </div> 
          `, false); 
        }, 500); 
      } 
      
      // MODIFICAR A FUNÇÃO showTodaySummary (substituir a existente) 
      showTodaySummary(hojeStr) { 
        const hoje = new Date(hojeStr + 'T00:00:00'); // Converte para objeto Date 
        const dataFormatada = this.formatDynamicDate(hoje); // Usa formatação dinâmica 
        
        // Buscar atividades registradas hoje 
        const dailyActivities = JSON.parse(localStorage.getItem('dailyActivities')) || { activities: {} }; 
        const atividades = dailyActivities.activities; 
        
        // Calcular tempo total 
        let totalTime = 0; 
        let totalAnkiDecks = 0; 
        let totalQuestoes = 0;
        let totalTeoria = 0;
        
        if (atividades.questoes && atividades.questoes.length > 0) { 
          atividades.questoes.forEach(q => {
            totalTime += q.tempo;
            totalQuestoes++;
          }); 
        } 
        
        if (atividades.anki && atividades.anki.length > 0) { 
          atividades.anki.forEach(a => { 
            totalTime += a.tempo; 
            totalAnkiDecks++; 
          }); 
        } 
        
        if (atividades.teoria && atividades.teoria.length > 0) { 
          atividades.teoria.forEach(t => {
            totalTime += t.tempo;
            totalTeoria++;
          }); 
        } 
        
        // Calcular horas e minutos 
        const hours = Math.floor(totalTime / 60); 
        const minutes = totalTime % 60; 
        
        let summaryHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-calendar-day"></i> 
              <div class="message-card-title">Resumo do Dia - ${dataFormatada}</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-alert message-alert-success"> 
                <i class="fas fa-check-circle"></i> 
                <div><strong>Parabéns! Você já estudou hoje.</strong></div> 
              </div> 
        `; 
        
        // Questões 
        if (atividades.questoes && atividades.questoes.length > 0) { 
          summaryHTML += ` 
            <div class="message-section"> 
              <div class="message-section-title">Questões Realizadas</div> 
              <div class="message-list"> 
          `; 
          atividades.questoes.forEach(q => { 
            const acertos = q.feitas - q.erradas; 
            const taxaAcerto = q.feitas > 0 ? Math.round((acertos / q.feitas) * 100) : 0; 
            
            summaryHTML += ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">${q.assunto}</div> 
                    <div class="message-list-description">${q.feitas} questões • ${taxaAcerto}% de acerto • ${q.tempo} min</div> 
                  </div> 
                </div> 
            `; 
          }); 
          summaryHTML += ` 
              </div> 
            </div> 
          `; 
        } 
        
        // Anki 
        if (atividades.anki && atividades.anki.length > 0) { 
          summaryHTML += ` 
            <div class="message-section"> 
              <div class="message-section-title">Revisões Anki</div> 
              <div class="message-list"> 
          `; 
          atividades.anki.forEach(a => { 
            summaryHTML += ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">${a.deck}</div> 
                    <div class="message-list-description">${a.cards} cards revisados • ${a.tempo} min</div> 
                  </div> 
                </div> 
            `; 
          }); 
          summaryHTML += ` 
              </div> 
            </div> 
          `; 
        } 
        
        // Teoria 
        if (atividades.teoria && atividades.teoria.length > 0) { 
          summaryHTML += ` 
            <div class="message-section"> 
              <div class="message-section-title">Estudo Teórico</div> 
              <div class="message-list"> 
          `; 
          atividades.teoria.forEach(t => { 
            summaryHTML += ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">${t.materia}</div> 
                    <div class="message-list-description">${t.conteudo || t.pagina || 'Estudo concluído'} • ${t.tempo} min</div> 
                  </div> 
                </div> 
            `; 
          }); 
          summaryHTML += ` 
              </div> 
            </div> 
          `; 
        } 
        
        // Resumo final - MODIFICAÇÃO APLICADA: EXPANDIR PARA MÚLTIPLOS BLOCOS
        summaryHTML += ` 
              <div class="message-divider"></div> 
              <div class="message-stats"> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${hours}h ${minutes}m</div> 
                  <div class="message-stat-label">Tempo Total</div> 
                </div> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${totalAnkiDecks}</div> 
                  <div class="message-stat-label">Baralhos Revisados</div> 
                </div> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${totalQuestoes}</div> 
                  <div class="message-stat-label">Blocos de Questões</div> 
                </div> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${totalTeoria}</div> 
                  <div class="message-stat-label">Estudos Teóricos</div> 
                </div> 
              </div> 
        `;
        
        // NOVA FUNCIONALIDADE: Comparação com o dia anterior
        const comparacaoHTML = this.generateComparacaoComOntem(hojeStr, atividades, totalTime);
        summaryHTML += comparacaoHTML;
        
        summaryHTML += ` 
              <div class="message-alert message-alert-info"> 
                <i class="fas fa-info-circle"></i> 
                <div><strong>Volte amanhã para novas atividades!</strong></div> 
              </div> 
        `; 
        
        summaryHTML += ` 
            </div> 
          </div> 
        `; 
        
        this.addBotMessage(summaryHTML, true, 'today-summary'); 
        
        // Não mostrar botão de registrar, pois já registrou hoje 
        setTimeout(() => { 
          this.addBotMessage(` 
            <div class="quick-actions"> 
              <button class="action-btn info" onclick="chatBot.showHelp()"> 
                <i class="fas fa-question-circle"></i> Preciso de Ajuda 
              </button> 
            </div> 
          `, false); 
        }, 500); 
      } 
      
      // NOVA FUNÇÃO: Gerar comparação com o dia anterior
      generateComparacaoComOntem(hojeStr, atividades, totalTime) {
        // Buscar dados de ontem
        const ontem = new Date();
        ontem.setDate(ontem.getDate() - 1);
        const ontemStr = ontem.toISOString().split('T')[0];
        const ontemActivities = JSON.parse(localStorage.getItem(`dailyActivities_${ontemStr}`)) || { activities: {} };
        
        // Se não houver dados de ontem, retornar string vazia
        if (!ontemActivities.activities || Object.keys(ontemActivities.activities).length === 0) {
          return '';
        }
        
        // Calcular totais de ontem
        let ontemTotalTime = 0;
        let ontemTotalQuestoes = 0;
        let ontemTotalAcertos = 0;
        let ontemTotalAnkiDecks = 0;
        
        if (ontemActivities.activities.questoes && ontemActivities.activities.questoes.length > 0) {
          ontemActivities.activities.questoes.forEach(q => {
            ontemTotalTime += q.tempo;
            ontemTotalQuestoes += q.feitas;
            ontemTotalAcertos += (q.feitas - q.erradas);
          });
        }
        
        if (ontemActivities.activities.anki && ontemActivities.activities.anki.length > 0) {
          ontemTotalAnkiDecks += ontemActivities.activities.anki.length;
          ontemActivities.activities.anki.forEach(a => {
            ontemTotalTime += a.tempo;
          });
        }
        
        if (ontemActivities.activities.teoria && ontemActivities.activities.teoria.length > 0) {
          ontemActivities.activities.teoria.forEach(t => {
            ontemTotalTime += t.tempo;
          });
        }
        
        // Calcular totais de hoje
        let hojeTotalQuestoes = 0;
        let hojeTotalAcertos = 0;
        
        if (atividades.questoes && atividades.questoes.length > 0) {
          atividades.questoes.forEach(q => {
            hojeTotalQuestoes += q.feitas;
            hojeTotalAcertos += (q.feitas - q.erradas);
          });
        }
        
        // Calcular diferenças
        const diffTime = totalTime - ontemTotalTime;
        const diffQuestoes = hojeTotalQuestoes - ontemTotalQuestoes;
        const diffAnkiDecks = (atividades.anki ? atividades.anki.length : 0) - ontemTotalAnkiDecks;
        
        // Calcular porcentagens de acerto
        const hojeAcertosPercent = hojeTotalQuestoes > 0 ? (hojeTotalAcertos / hojeTotalQuestoes) * 100 : 0;
        const ontemAcertosPercent = ontemTotalQuestoes > 0 ? (ontemTotalAcertos / ontemTotalQuestoes) * 100 : 0;
        const diffAcertosPercent = hojeAcertosPercent - ontemAcertosPercent;
        
        // Gerar HTML da comparação
        let comparacaoHTML = `
          <div class="message-section">
            <div class="message-section-title">Comparação com Ontem</div>
            <div class="message-list">
        `;
        
        // Horas estudadas
        let timeIcon = '⏱️';
        let timeText = '';
        if (diffTime > 0) {
          timeText = `<span style="color: var(--success)">+${diffTime} min</span> em relação a ontem`;
        } else if (diffTime < 0) {
          timeText = `<span style="color: var(--danger)">${diffTime} min</span> em relação a ontem`;
        } else {
          timeText = `Mesmo tempo de estudo que ontem`;
        }
        comparacaoHTML += `
          <div class="message-list-item">
            <div class="message-list-icon">${timeIcon}</div>
            <div class="message-list-content">
              <div class="message-list-title">Horas estudadas</div>
              <div class="message-list-description">${timeText}</div>
            </div>
          </div>
        `;
        
        // Questões resolvidas
        let questoesIcon = '🧩';
        let questoesText = '';
        if (diffQuestoes > 0) {
          questoesText = `<span style="color: var(--success)">+${diffQuestoes} questões</span> em relação a ontem`;
        } else if (diffQuestoes < 0) {
          questoesText = `<span style="color: var(--danger)">${diffQuestoes} questões</span> em relação a ontem`;
        } else {
          questoesText = `Mesma quantidade de questões que ontem`;
        }
        comparacaoHTML += `
          <div class="message-list-item">
            <div class="message-list-icon">${questoesIcon}</div>
            <div class="message-list-content">
              <div class="message-list-title">Questões resolvidas</div>
              <div class="message-list-description">${questoesText}</div>
            </div>
          </div>
        `;
        
        // Porcentagem de acertos
        let acertosIcon = '📊';
        let acertosText = '';
        if (diffAcertosPercent > 0) {
          acertosText = `<span style="color: var(--success)">+${diffAcertosPercent.toFixed(1)}%</span> em relação a ontem`;
        } else if (diffAcertosPercent < 0) {
          acertosText = `<span style="color: var(--danger)">${diffAcertosPercent.toFixed(1)}%</span> em relação a ontem`;
        } else {
          acertosText = `Mesma porcentagem de acertos que ontem`;
        }
        comparacaoHTML += `
          <div class="message-list-item">
            <div class="message-list-icon">${acertosIcon}</div>
            <div class="message-list-content">
              <div class="message-list-title">Porcentagem de acertos</div>
              <div class="message-list-description">${acertosText}</div>
            </div>
          </div>
        `;
        
        // Flashcards revisados
        let flashcardsIcon = '🔁';
        let flashcardsText = '';
        if (diffAnkiDecks > 0) {
          flashcardsText = `<span style="color: var(--success)">+${diffAnkiDecks} baralhos</span> em relação a ontem`;
        } else if (diffAnkiDecks < 0) {
          flashcardsText = `<span style="color: var(--danger)">${diffAnkiDecks} baralhos</span> em relação a ontem`;
        } else {
          flashcardsText = `Mesma quantidade de baralhos que ontem`;
        }
        comparacaoHTML += `
          <div class="message-list-item">
            <div class="message-list-icon">${flashcardsIcon}</div>
            <div class="message-list-content">
              <div class="message-list-title">Flashcards revisados</div>
              <div class="message-list-description">${flashcardsText}</div>
            </div>
          </div>
        `;
        
        comparacaoHTML += `
            </div>
          </div>
        `;
        
        return comparacaoHTML;
      }
      
      // MODIFICAR A FUNÇÃO openRegisterModal (substituir a existente) 
      openRegisterModal() { 
        const hojeStr = this.getDynamicDateString(); // SEMPRE usa data atual 
        
        // CORREÇÃO APLICADA: Verificar se já registrou HOJE usando a nova função 
        if (this.hasStudiedToday()) { 
          this.typeMessage("Você já registrou suas atividades hoje! 😊\n\nSe quiser ver o resumo do que foi feito, peça o <strong>resumo do dia</strong>.", this.narrationEnabled); 
          return; 
        } 
        
        document.getElementById('registerModal').style.display = 'flex'; 
        this.loadTodayTasks(); 
      } 
      
      // MODIFICAR A FUNÇÃO addDateDivider (substituir a existente) 
      addDateDivider() { 
        const hoje = this.getDynamicDateObject(); // SEMPRE usa data atual 
        const dataFormatada = this.formatDynamicDate(hoje); 
        
        const chatMessages = document.getElementById('chatMessages'); 
        const dateDiv = document.createElement('div'); 
        dateDiv.className = 'chat-date'; 
        dateDiv.innerHTML = `<span>${dataFormatada}</span>`; 
        chatMessages.appendChild(dateDiv); 
      } 
      
      // Modal de configuração 
      showConfigModal() { 
        document.getElementById('configModal').style.display = 'flex'; 
        document.getElementById('materiasPorDia').value = this.materiasPorDia; 
      } 
      
      closeConfigModal() { 
        document.getElementById('configModal').style.display = 'none'; 
      } 
      
      saveConfig() { 
        const materiasPorDia = parseInt(document.getElementById('materiasPorDia').value); 
        if (materiasPorDia >= 1 && materiasPorDia <= 5) { 
          this.materiasPorDia = materiasPorDia; 
          localStorage.setItem('studyFlow_materiasPorDia', materiasPorDia.toString()); 
          this.closeConfigModal(); 
          this.typeMessage(`Configuração salva! Agora você verá ${materiasPorDia} matéria(s) por dia.`, this.narrationEnabled); 
        } else { 
          alert('Por favor, informe um número entre 1 e 5.'); 
        } 
      } 
      
      // NOVAS FUNÇÕES: Modal de Programar Simulado
      showSimuladoModal() {
        document.getElementById('simuladoModal').style.display = 'flex';
        const simuladoConfig = JSON.parse(localStorage.getItem('studyFlow_simuladoConfig')) || {};
        document.getElementById('simuladoInterval').value = simuladoConfig.interval || '0';
      }
      
      closeSimuladoModal() {
        document.getElementById('simuladoModal').style.display = 'none';
      }
      
      saveSimuladoConfig() {
        const interval = parseInt(document.getElementById('simuladoInterval').value);
        const simuladoConfig = {
          interval: interval
        };
        
        if (interval > 0) {
          // Calcular próxima data de simulado
          const hoje = new Date();
          const nextSimulado = new Date();
          nextSimulado.setDate(hoje.getDate() + interval);
          simuladoConfig.nextSimulado = nextSimulado.toISOString();
        }
        
        localStorage.setItem('studyFlow_simuladoConfig', JSON.stringify(simuladoConfig));
        this.closeSimuladoModal();
        this.typeMessage('Configuração de simulado salva!', this.narrationEnabled);
      }
      
      // NOVAS FUNÇÕES: Modal de Relatório Periódico
      showRelatorioModal() {
        document.getElementById('relatorioModal').style.display = 'flex';
      }
      
      closeRelatorioModal() {
        document.getElementById('relatorioModal').style.display = 'none';
      }
      
      generateRelatorio() {
        const periodo = parseInt(document.getElementById('relatorioPeriodo').value);
        this.closeRelatorioModal();
        
        // Buscar histórico de atividades
        const hoje = new Date();
        const periodData = this.getPeriodData(periodo);
        const previousPeriodData = this.getPeriodData(periodo, periodo);
        
        // Calcular totais do período atual
        const atualTotais = this.calculatePeriodTotals(periodData);
        const anteriorTotais = this.calculatePeriodTotals(previousPeriodData);
        
        // Gerar relatório
        const relatorioHTML = this.generateRelatorioHTML(periodo, atualTotais, anteriorTotais);
        this.addBotMessage(relatorioHTML, true, 'relatorio-periodico');
      }
      
      getPeriodData(dias, offset = 0) {
        const data = [];
        const hoje = new Date();
        
        for (let i = offset + dias - 1; i >= offset; i--) {
          const dataItem = new Date();
          dataItem.setDate(hoje.getDate() - i);
          const dataStr = dataItem.toISOString().split('T')[0];
          const atividades = JSON.parse(localStorage.getItem(`dailyActivities_${dataStr}`)) || { activities: {} };
          
          if (Object.keys(atividades.activities).length > 0) {
            data.push({
              date: dataStr,
              atividades: atividades.activities
            });
          }
        }
        
        return data;
      }
      
      calculatePeriodTotals(periodData) {
        const totais = {
          totalTime: 0,
          totalQuestoes: 0,
          totalAcertos: 0,
          totalAnkiDecks: 0,
          totalFlashcards: 0
        };
        
        periodData.forEach(dia => {
          if (dia.atividades.questoes && dia.atividades.questoes.length > 0) {
            dia.atividades.questoes.forEach(q => {
              totais.totalTime += q.tempo;
              totais.totalQuestoes += q.feitas;
              totais.totalAcertos += (q.feitas - q.erradas);
            });
          }
          
          if (dia.atividades.anki && dia.atividades.anki.length > 0) {
            totais.totalAnkiDecks += dia.atividades.anki.length;
            dia.atividades.anki.forEach(a => {
              totais.totalTime += a.tempo;
              totais.totalFlashcards += a.cards;
            });
          }
          
          if (dia.atividades.teoria && dia.atividades.teoria.length > 0) {
            dia.atividades.teoria.forEach(t => {
              totais.totalTime += t.tempo;
            });
          }
        });
        
        return totais;
      }
      
      generateRelatorioHTML(periodo, atualTotais, anteriorTotais) {
        // Calcular diferenças
        const diffTime = atualTotais.totalTime - anteriorTotais.totalTime;
        const diffQuestoes = atualTotais.totalQuestoes - anteriorTotais.totalQuestoes;
        const diffAnkiDecks = atualTotais.totalAnkiDecks - anteriorTotais.totalAnkiDecks;
        const diffFlashcards = atualTotais.totalFlashcards - anteriorTotais.totalFlashcards;
        
        // Calcular porcentagens de acerto
        const atualAcertosPercent = atualTotais.totalQuestoes > 0 ? (atualTotais.totalAcertos / atualTotais.totalQuestoes) * 100 : 0;
        const anteriorAcertosPercent = anteriorTotais.totalQuestoes > 0 ? (anteriorTotais.totalAcertos / anteriorTotais.totalQuestoes) * 100 : 0;
        const diffAcertosPercent = atualAcertosPercent - anteriorAcertosPercent;
        
        // Calcular horas e minutos
        const atualHours = Math.floor(atualTotais.totalTime / 60);
        const atualMinutes = atualTotais.totalTime % 60;
        
        return `
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-chart-bar"></i>
              <div class="message-card-title">Relatório Periódico (${periodo} dias)</div>
            </div>
            <div class="message-card-content">
              <div class="message-stats">
                <div class="message-stat">
                  <div class="message-stat-value">${atualHours}h ${atualMinutes}m</div>
                  <div class="message-stat-label">Tempo Total</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${atualTotais.totalQuestoes}</div>
                  <div class="message-stat-label">Questões</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${atualAcertosPercent.toFixed(1)}%</div>
                  <div class="message-stat-label">Acertos</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${atualTotais.totalFlashcards}</div>
                  <div class="message-stat-label">Flashcards</div>
                </div>
              </div>
              
              <div class="message-section">
                <div class="message-section-title">Comparação com Período Anterior</div>
                <div class="message-list">
                  <div class="message-list-item">
                    <div class="message-list-icon">⏱️</div>
                    <div class="message-list-content">
                      <div class="message-list-title">Horas estudadas</div>
                      <div class="message-list-description">
                        ${diffTime > 0 ? 
                          `<span style="color: var(--success)">+${diffTime} min</span> em relação ao período anterior` : 
                          diffTime < 0 ? 
                          `<span style="color: var(--danger)">${diffTime} min</span> em relação ao período anterior` : 
                          'Mesmo tempo de estudo que o período anterior'}
                      </div>
                    </div>
                  </div>
                  
                  <div class="message-list-item">
                    <div class="message-list-icon">🧩</div>
                    <div class="message-list-content">
                      <div class="message-list-title">Questões resolvidas</div>
                      <div class="message-list-description">
                        ${diffQuestoes > 0 ? 
                          `<span style="color: var(--success)">+${diffQuestoes} questões</span> em relação ao período anterior` : 
                          diffQuestoes < 0 ? 
                          `<span style="color: var(--danger)">${diffQuestoes} questões</span> em relação ao período anterior` : 
                          'Mesma quantidade de questões que o período anterior'}
                      </div>
                    </div>
                  </div>
                  
                  <div class="message-list-item">
                    <div class="message-list-icon">📊</div>
                    <div class="message-list-content">
                      <div class="message-list-title">Porcentagem de acertos</div>
                      <div class="message-list-description">
                        ${diffAcertosPercent > 0 ? 
                          `<span style="color: var(--success)">+${diffAcertosPercent.toFixed(1)}%</span> em relação ao período anterior` : 
                          diffAcertosPercent < 0 ? 
                          `<span style="color: var(--danger)">${diffAcertosPercent.toFixed(1)}%</span> em relação ao período anterior` : 
                          'Mesma porcentagem de acertos que o período anterior'}
                      </div>
                    </div>
                  </div>
                  
                  <div class="message-list-item">
                    <div class="message-list-icon">🔁</div>
                    <div class="message-list-content">
                      <div class="message-list-title">Flashcards revisados</div>
                      <div class="message-list-description">
                        ${diffFlashcards > 0 ? 
                          `<span style="color: var(--success)">+${diffFlashcards} flashcards</span> em relação ao período anterior` : 
                          diffFlashcards < 0 ? 
                          `<span style="color: var(--danger)">${diffFlashcards} flashcards</span> em relação ao período anterior` : 
                          'Mesma quantidade de flashcards que o período anterior'}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // CORREÇÃO APLICADA: Função para obter baralhos do Anki atualizados 
      getTodayDecks() { 
        const ankiData = this.getModuleData('ciclos_focus_v1'); 
        if (!ankiData || !ankiData.decks || !ankiData.perDay) return []; 
        
        const perDay = ankiData.perDay; 
        const blockIndex = ankiData.blockIndex || 0; 
        
        // Calcular os baralhos do dia atual baseado no blockIndex atual 
        const startIndex = blockIndex * perDay; 
        const todayDecks = ankiData.decks.slice(startIndex, startIndex + perDay); 
        
        // Retornar apenas os nomes dos baralhos 
        return todayDecks.map(deck => deck.name); 
      } 
      
      // CORREÇÃO APLICADA: Função para obter tarefas do dia atualizada 
      getTodayTasks() { 
        const hoje = new Date(); 
        const hojeStr = hoje.toISOString().split('T')[0]; 
        
        const tasks = { 
          questoes: [], 
          anki: [], 
          teoria: [] 
        }; 
        
        // Buscar assuntos para questões de hoje (revisão) - APENAS AS DO DIA 
        tasks.questoes = this.calculateTodayReviews(); 
        
        // CORREÇÃO APLICADA: Buscar baralhos do Anki para hoje (atualizados) 
        tasks.anki = this.getTodayDecks().map(deckName => ({ 
          id: deckName, 
          nome: deckName, 
          emoji: '🔁' 
        })); 
        
        // Buscar matérias de teoria para hoje (ciclo teórico) - COM MÚLTIPLAS MATÉRIAS 
        const activeCycle = this.getActiveCycle(); 
        if (activeCycle && activeCycle.generatedCycle) { 
          // Obter as próximas matérias baseado na configuração 
          tasks.teoria = this.getTodaySubjects(); 
        } 
        
        return tasks; 
      } 
      
      // CORREÇÃO CRÍTICA: Função para ativar/desativar tarefas no modal 
      activateTask(button) { 
        const card = button.closest('.task-card'); 
        
        // Alternar entre os estados disabled e active
        if (card.classList.contains('disabled')) {
          card.classList.remove('disabled');
          card.classList.add('active');
          
          // Habilitar todos os inputs dentro do card
          const inputs = card.querySelectorAll('input');
          inputs.forEach(input => {
            input.disabled = false;
          });
        } else {
          card.classList.remove('active');
          card.classList.add('disabled');
          
          // Desabilitar todos os inputs dentro do card
          const inputs = card.querySelectorAll('input');
          inputs.forEach(input => {
            input.disabled = true;
          });
        }
      }
      
      // MODIFICAR A FUNÇÃO loadTodayTasks (substituir a existente) 
      loadTodayTasks() { 
        const modalBody = document.getElementById('registerModalBody'); 
        modalBody.innerHTML = ''; 
        
        const todayTasks = this.getTodayTasks(); 
        
        if (todayTasks.questoes.length === 0 && todayTasks.anki.length === 0 && todayTasks.teoria.length === 0) { 
          modalBody.innerHTML = ` 
            <div class="empty-state"> 
              <i class="fas fa-check-circle"></i> 
              <h3>Não há tarefas pendentes para hoje!</h3> 
              <p>Parabéns! Você já concluiu todas as tarefas de hoje ou não há atividades programadas.</p> 
            </div> 
          `; 
          return; 
        } 
        
        let tasksHTML = '<div class="tasks-grid">'; 
        
        // Adicionar cards para questões (apenas as do dia) 
        todayTasks.questoes.forEach(questao => { 
          tasksHTML += this.createQuestaoCard(questao); 
        }); 
        
        // Adicionar cards para Anki 
        todayTasks.anki.forEach(deck => { 
          tasksHTML += this.createAnkiCard(deck); 
        }); 
        
        // Adicionar cards para teoria - COM MÚLTIPLAS MATÉRIAS 
        todayTasks.teoria.forEach(materia => { 
          tasksHTML += this.createTeoriaCard(materia); 
        }); 
        
        tasksHTML += '</div>'; 
        modalBody.innerHTML = tasksHTML; 
      } 
      
      createQuestaoCard(questao) { 
        return ` 
          <div class="task-card disabled" data-type="questoes" data-id="${questao.id}"> 
            <div class="task-header"> 
              <div class="task-icon-large">🧩</div> 
              <div class="task-title">Questões: ${questao.disciplina}</div> 
              <button class="activate-btn" onclick="chatBot.activateTask(this)">Ativar</button> 
            </div> 
            <div class="task-description"> 
              <strong>Assunto:</strong> ${questao.nome} 
            </div> 
            <div class="task-form"> 
              <div class="form-group"> 
                <label for="questoes-feitas-${questao.id}">Quantidade de questões feitas</label> 
                <input type="number" id="questoes-feitas-${questao.id}" min="0" placeholder="Ex: 20" disabled> 
              </div> 
              <div class="form-group"> 
                <label for="questoes-erradas-${questao.id}">Quantidade de questões erradas</label> 
                <input type="number" id="questoes-erradas-${questao.id}" min="0" placeholder="Ex: 5" disabled> 
              </div> 
              <div class="form-group"> 
                <label for="questoes-tempo-${questao.id}">Tempo total gasto (minutos)</label> 
                <input type="number" id="questoes-tempo-${questao.id}" min="0" placeholder="Ex: 45" disabled> 
              </div> 
            </div> 
          </div> 
        `; 
      } 
      
      createAnkiCard(deck) { 
        return ` 
          <div class="task-card disabled" data-type="anki" data-id="${deck.id}"> 
            <div class="task-header"> 
              <div class="task-icon-large">${deck.emoji}</div> 
              <div class="task-title">Revisão Anki</div> 
              <button class="activate-btn" onclick="chatBot.activateTask(this)">Ativar</button> 
            </div> 
            <div class="task-description"> 
              <strong>Baralho:</strong> ${deck.nome} 
            </div> 
            <div class="task-form"> 
              <div class="form-group"> 
                <label for="anki-tempo-${deck.id}">Tempo de estudo (minutos)</label> 
                <input type="number" id="anki-tempo-${deck.id}" min="0" placeholder="Ex: 30" disabled> 
              </div> 
              <div class="form-group"> 
                <label for="anki-cards-${deck.id}">Quantidade de cards revisados</label> 
                <input type="number" id="anki-cards-${deck.id}" min="0" placeholder="Ex: 50" disabled> 
              </div> 
            </div> 
          </div> 
        `; 
      } 
      
      createTeoriaCard(materia) { 
        return ` 
          <div class="task-card disabled" data-type="teoria" data-id="${materia}"> 
            <div class="task-header"> 
              <div class="task-icon-large">📚</div> 
              <div class="task-title">Estudo Teórico</div> 
              <button class="activate-btn" onclick="chatBot.activateTask(this)">Ativar</button> 
            </div> 
            <div class="task-description"> 
              <strong>Matéria:</strong> ${materia} 
            </div> 
            <div class="task-form"> 
              <div class="form-group"> 
                <label for="teoria-conteudo-${materia}">Conteúdo estudado (PDF/Aula)</label> 
                <input type="text" id="teoria-conteudo-${materia}" placeholder="Ex: PDF Aula 1, Video Aula 2" disabled> 
              </div> 
              <div class="form-group"> 
                <label for="teoria-pagina-${materia}">Página/Progresso</label> 
                <input type="text" id="teoria-pagina-${materia}" placeholder="Ex: Página 42, 50% concluído" disabled> 
              </div> 
              <div class="form-group"> 
                <label for="teoria-tempo-${materia}">Tempo de estudo (minutos)</label> 
                <input type="number" id="teoria-tempo-${materia}" min="0" placeholder="Ex: 60" disabled> 
              </div> 
            </div> 
          </div> 
        `; 
      } 
      
      // NOVA FUNÇÃO: Salvar apenas as tarefas selecionadas 
      saveSelectedTasks() { 
        const activeCards = document.querySelectorAll('.task-card.active'); 
        let hasError = false; 
        let savedCount = 0; 
        let totalTime = 0; 
        let activities = { 
          questoes: [], 
          anki: [], 
          teoria: [] 
        }; 
        
        if (activeCards.length === 0) { 
          alert('Por favor, selecione pelo menos uma atividade para registrar.'); 
          return; 
        } 
        
        // CORREÇÃO APLICADA: Usar a data atual para o registro de hoje
        const hoje = new Date();
        const hojeStr = hoje.toISOString().split('T')[0];
        
        activeCards.forEach(card => { 
          const type = card.getAttribute('data-type'); 
          const id = card.getAttribute('data-id'); 
          
          if (type === 'questoes') { 
            const feitas = document.getElementById(`questoes-feitas-${id}`).value; 
            const erradas = document.getElementById(`questoes-erradas-${id}`).value; 
            const tempo = document.getElementById(`questoes-tempo-${id}`).value; 
            
            if (!feitas || !tempo) { 
              hasError = true; 
              card.style.border = '1px solid red'; 
            } else { 
              card.style.border = ''; 
              // CORREÇÃO APLICADA: Chamar a função de salvamento para questões com data atual
              this.saveQuestoes(id, feitas, erradas, tempo, hojeStr);
              savedCount++; 
              totalTime += parseInt(tempo); 
              activities.questoes.push({ 
                assunto: id, 
                feitas: parseInt(feitas), 
                erradas: parseInt(erradas), 
                tempo: parseInt(tempo) 
              }); 
            } 
          } else if (type === 'anki') { 
            const tempo = document.getElementById(`anki-tempo-${id}`).value; 
            const cards = document.getElementById(`anki-cards-${id}`).value; 
            
            if (!tempo || !cards) { 
              hasError = true; 
              card.style.border = '1px solid red'; 
            } else { 
              card.style.border = ''; 
              // CORREÇÃO APLICADA: Chamar a função de salvamento para Anki com data atual
              this.saveAnki(id, tempo, cards, hojeStr);
              savedCount++; 
              totalTime += parseInt(tempo); 
              activities.anki.push({ 
                deck: id, 
                tempo: parseInt(tempo), 
                cards: parseInt(cards) 
              }); 
            } 
          } else if (type === 'teoria') { 
            const conteudo = document.getElementById(`teoria-conteudo-${id}`).value; 
            const pagina = document.getElementById(`teoria-pagina-${id}`).value; 
            const tempo = document.getElementById(`teoria-tempo-${id}`).value; 
            
            if (!tempo) { 
              hasError = true; 
              card.style.border = '1px solid red'; 
            } else { 
              card.style.border = ''; 
              // CORREÇÃO APLICADA: Chamar a função de salvamento para teoria com data atual
              this.saveTeoria(id, conteudo, pagina, tempo, hojeStr);
              savedCount++; 
              totalTime += parseInt(tempo); 
              activities.teoria.push({ 
                materia: id, 
                conteudo: conteudo, 
                pagina: pagina, 
                tempo: parseInt(tempo) 
              }); 
            } 
          } 
        }); 
        
        if (hasError) { 
          alert('Preencha todos os campos obrigatórios das atividades selecionadas!'); 
          return; 
        } 
        
        // Salvar a data do último registro 
        localStorage.setItem('lastRegisterDate', hojeStr); 
        
        // Salvar as atividades do dia 
        const dailyActivities = { 
          date: hojeStr, 
          activities: activities 
        }; 
        localStorage.setItem('dailyActivities', JSON.stringify(dailyActivities)); 
        
        // NOVO: Salvar também com chave específica da data para histórico
        localStorage.setItem(`dailyActivities_${hojeStr}`, JSON.stringify(dailyActivities));
        
        this.closeRegisterModal(); 
        
        if (savedCount > 0) { 
          this.showRegistrationSummary(savedCount, totalTime, activities); 
        } 
      } 
      
      showRegistrationSummary(savedCount, totalTime, activities, isYesterday = false) { 
        // Mensagem de sucesso destacada 
        const successMessage = ` 
          <div class="message-bubble bot-bubble message-alert-success"> 
            <div class="message-content"> 
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px"> 
                <i class="fas fa-check-circle" style="color: var(--success)"></i> 
                <strong>${savedCount} atividade(s) registrada(s) com sucesso${isYesterday ? ' para ontem' : ''}!</strong> 
              </div> 
              <div class="message-text"> 
                Seu progresso foi salvo e suas próximas revisões foram atualizadas. 
              </div> 
            </div> 
            <div class="bubble-time">${this.formatTime(new Date())}</div> 
          </div> 
        `; 
        
        // Adicionar a mensagem de sucesso 
        const chatMessages = document.getElementById('chatMessages'); 
        const messageContainer = document.createElement('div'); 
        messageContainer.className = 'message-container bot-container'; 
        const avatar = document.createElement('div'); 
        avatar.className = 'avatar bot-avatar-small'; 
        avatar.innerHTML = '<i class="fas fa-robot"></i>'; 
        messageContainer.appendChild(avatar); 
        messageContainer.innerHTML = successMessage; 
        chatMessages.appendChild(messageContainer); 
        chatMessages.scrollTop = chatMessages.scrollHeight; 
        
        setTimeout(() => { 
          let summaryHTML = ` 
            <div class="message-card"> 
              <div class="message-card-header"> 
                <i class="fas fa-chart-bar"></i> 
                <div class="message-card-title">Resumo das Atividades${isYesterday ? ' de Ontem' : ' de Hoje'}</div> 
              </div> 
              <div class="message-card-content"> 
          `; 
          
          // Adicionar questões 
          if (activities.questoes.length > 0) { 
            summaryHTML += `<div class="message-section-title">🧩 Questões</div>`; 
            activities.questoes.forEach(q => { 
              const acertos = q.feitas - q.erradas; 
              const taxaAcerto = q.feitas > 0 ? Math.round((acertos / q.feitas) * 100) : 0; 
              
              summaryHTML += ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">${q.assunto}</div> 
                    <div class="message-list-description">${q.feitas} questões (${taxaAcerto}% acerto)</div> 
                  </div> 
                </div> 
              `; 
            }); 
          } 
          
          // Adicionar Anki 
          if (activities.anki.length > 0) { 
            summaryHTML += `<div class="message-section-title">🔁 Anki</div>`; 
            activities.anki.forEach(a => { 
              summaryHTML += ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">${a.deck}</div> 
                    <div class="message-list-description">${a.cards} cards revisados</div> 
                  </div> 
                </div> 
              `; 
            }); 
          } 
          
          // Adicionar teoria 
          if (activities.teoria.length > 0) { 
            summaryHTML += `<div class="message-section-title">📚 Teoria</div>`; 
            activities.teoria.forEach(t => { 
              summaryHTML += ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">${t.materia}</div> 
                    <div class="message-list-description">${t.conteudo || t.pagina || 'Estudo'}</div> 
                  </div> 
                </div> 
              `; 
            }); 
          } 
          
          // Total 
          summaryHTML += ` 
                <div class="message-divider"></div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-clock"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Tempo Total</div> 
                    <div class="message-list-description">${totalTime} minutos</div> 
                  </div> 
                </div> 
          `; 
          
          summaryHTML += `</div></div>`; 
          this.addBotMessage(summaryHTML, false); 
          
          setTimeout(() => { 
            // Mostrar próximas datas de revisão 
            const nextReviews = this.getNextReviewDates(); 
            if (nextReviews.length > 0) { 
              let nextReviewsHTML = ` 
                <div class="message-card"> 
                  <div class="message-card-header"> 
                    <i class="fas fa-calendar-alt"></i> 
                    <div class="message-card-title">Próximas Revisões</div> 
                  </div> 
                  <div class="message-card-content"> 
              `; 
              
              nextReviews.forEach(review => { 
                nextReviewsHTML += ` 
                  <div class="message-list-item"> 
                    <div class="message-list-icon"><i class="fas fa-calendar-day"></i></div> 
                    <div class="message-list-content"> 
                      <div class="message-list-title">${review.assunto}</div> 
                      <div class="message-list-description">${review.data}</div> 
                    </div> 
                  </div> 
                `; 
              }); 
              
              nextReviewsHTML += `</div></div>`; 
              this.addBotMessage(nextReviewsHTML, false); 
            } 
          }, 500); 
        }, 500); 
      } 
      
      getNextReviewDates() { 
        const disciplines = this.getModuleData('disciplines'); 
        const nextReviews = []; 
        const hoje = new Date(); 
        
        if (disciplines && Array.isArray(disciplines)) { 
          disciplines.forEach(disciplina => { 
            if (disciplina.assuntos && Array.isArray(disciplina.assuntos)) { 
              disciplina.assuntos.forEach(assunto => { 
                if (assunto.nextReviewDate) { 
                  const nextDate = new Date(assunto.nextReviewDate); 
                  if (nextDate > hoje) { 
                    nextReviews.push({ 
                      assunto: assunto.nome, 
                      disciplina: disciplina.name, 
                      data: nextDate.toLocaleDateString('pt-BR') 
                    }); 
                  } 
                } 
              }); 
            } 
          }); 
        } 
        
        // Ordenar por data e pegar as 3 mais próximas 
        return nextReviews 
          .sort((a, b) => new Date(a.data) - new Date(b.data)) 
          .slice(0, 3); 
      } 
      
      // Funções de utilitário 
      toggleTheme() { 
        if (this.currentTheme === 'light') { 
          document.body.classList.add('dark-theme'); 
          document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>'; 
          this.currentTheme = 'dark'; 
        } else { 
          document.body.classList.remove('dark-theme'); 
          document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>'; 
          this.currentTheme = 'light'; 
        } 
        localStorage.setItem('theme', this.currentTheme); 
      } 
      
      addUserMessage(content) { 
        this.addMessageToChat(content, true); 
      } 
      
      // Buscar ciclo ativo de forma robusta 
      getActiveCycle() { 
        // Tentar diferentes chaves possíveis para o ciclo ativo 
        const possibleKeys = [ 
          'StudyFlow_activeCycle', 
          'StudyFlow_allCycles', 
          'activeCycle', 
          'StudyFlow_cycle', 
          'currentCycle' 
        ]; 
        
        for (const key of possibleKeys) { 
          const data = this.getModuleData(key); 
          if (data) { 
            // Se for um array (como StudyFlow_allCycles), pegar o primeiro ciclo 
            if (Array.isArray(data) && data.length > 0) { 
              const cycle = data[0]; 
              if (cycle && cycle.generatedCycle && Array.isArray(cycle.generatedCycle)) { 
                return cycle; 
              } 
            } 
            // Se for um objeto direto 
            else if (data.generatedCycle && Array.isArray(data.generatedCycle)) { 
              return data; 
            } 
          } 
        } 
        
        // Se não encontrou, tentar buscar em todas as chaves do localStorage 
        for (let i = 0; i < localStorage.length; i++) { 
          const key = localStorage.key(i); 
          if (key && (key.includes('cycle') || key.includes('Cycle') || key.includes('CYCLE'))) { 
            try { 
              const data = JSON.parse(localStorage.getItem(key)); 
              if (data) { 
                // Se for um array, pegar o primeiro item 
                if (Array.isArray(data) && data.length > 0) { 
                  const cycle = data[0]; 
                  if (cycle && cycle.generatedCycle && Array.isArray(cycle.generatedCycle)) { 
                    return cycle; 
                  } 
                } 
                // Se for um objeto direto 
                else if (data.generatedCycle && Array.isArray(data.generatedCycle)) { 
                  return data; 
                } 
              } 
            } catch (e) { 
              // Ignorar chaves que não são JSON válido 
            } 
          } 
        } 
        
        return null; 
      } 
      
      // Funções de integração com módulos 
      getModuleData(key) { 
        try { 
          const data = localStorage.getItem(key); 
          return data ? JSON.parse(data) : null; 
        } catch (e) { 
          console.error(`Erro ao carregar dados do módulo: ${key}`, e); 
          return null; 
        } 
      } 
      
      setModuleData(key, data) { 
        try { 
          localStorage.setItem(key, JSON.stringify(data)); 
          return true; 
        } catch (e) { 
          console.error(`Erro ao salvar dados no módulo: ${key}`, e); 
          return false; 
        } 
      } 
      
      // ALGORITMO DE PRIORIZAÇÃO IDÊNTICO AO MÓDULO DE REVISÕES 
      calculateTodayReviews(date = null) { 
        const disciplines = this.getModuleData('disciplines'); 
        const dailyReviewGoal = this.getModuleData('dailyReviewGoal') || 5; 
        
        if (!disciplines || !Array.isArray(disciplines)) return []; 
        
        const targetDate = date || new Date(); 
        const targetTimestamp = targetDate.getTime(); 
        
        let pendingTopics = []; 
        
        // Fase 1: Coletar todos os assuntos pendentes 
        disciplines.forEach(disciplina => { 
          if (disciplina.assuntos && Array.isArray(disciplina.assuntos)) { 
            disciplina.assuntos.forEach(assunto => { 
              // Ignorar assuntos suspensos 
              if (assunto.suspended) return; 
              
              // Verificar se está na data de revisão ou atrasado 
              if (assunto.nextReviewDate && assunto.nextReviewDate <= targetTimestamp) { 
                // Calcular dias de atraso 
                const daysOverdue = Math.max(0, Math.floor((targetTimestamp - assunto.nextReviewDate) / (1000 * 60 * 60 * 24))); 
                
                // Calcular dificuldade média (invertida: maior dificuldade = maior prioridade) 
                let avgDifficulty = 2; // padrão 
                if (assunto.difficultyHistory && assunto.difficultyHistory.length > 0) { 
                  avgDifficulty = assunto.difficultyHistory.reduce((a, b) => a + b, 0) / assunto.difficultyHistory.length; 
                } 
                const difficultyScore = (3 - avgDifficulty); // Inverte a escala 
                
                // Obter importância 
                const importance = assunto.importance || 3; 
                
                // Calcular prioridade (mesma fórmula do módulo de revisões) 
                const priority = (difficultyScore * 40) + (daysOverdue * 60) + (importance * 20); 
                
                pendingTopics.push({ 
                  id: assunto.nome, 
                  nome: assunto.nome, 
                  disciplina: disciplina.name, 
                  priority: priority, 
                  daysOverdue: daysOverdue, 
                  difficulty: avgDifficulty, 
                  importance: importance 
                }); 
              } 
            }); 
          } 
        }); 
        
        // Fase 2: Ordenar por prioridade (decrescente) 
        pendingTopics.sort((a, b) => b.priority - a.priority); 
        
        // Fase 3: Limitar pela meta diária 
        return pendingTopics.slice(0, dailyReviewGoal); 
      } 
      
      calculateOverdueReviews() { 
        const disciplines = this.getModuleData('disciplines'); 
        if (!disciplines || !Array.isArray(disciplines)) return 0; 
        
        const hoje = new Date(); 
        const todayTimestamp = hoje.getTime(); 
        
        let atrasadas = 0; 
        
        disciplines.forEach(disciplina => { 
          if (disciplina.assuntos && Array.isArray(disciplina.assuntos)) { 
            disciplina.assuntos.forEach(assunto => { 
              if (assunto.nextReviewDate && assunto.nextReviewDate < todayTimestamp && !assunto.suspended) { 
                atrasadas++; 
              } 
            }); 
          } 
        }); 
        
        return atrasadas; 
      } 
      
      // FUNÇÃO MELHORADA: Agora retorna múltiplas matérias baseado na configuração 
      getTodaySubjects(date = null) { 
        const activeCycle = this.getActiveCycle(); 
        if (!activeCycle || !activeCycle.generatedCycle) { 
          return []; 
        } 
        
        const targetDate = date || new Date(); 
        const todayIndex = activeCycle.currentDay || 0; 
        const materiasPorDia = this.materiasPorDia || 1; 
        
        let subjects = []; 
        const cycleLength = activeCycle.generatedCycle.length; 
        
        if (cycleLength === 0) { 
          return []; 
        } 
        
        // Ajustar o índice para estar dentro dos limites 
        const adjustedIndex = todayIndex % cycleLength; 
        
        // Pegar as próximas matérias baseado na configuração 
        for (let i = 0; i < materiasPorDia; i++) { 
          const index = (adjustedIndex + i) % cycleLength; 
          let subject = activeCycle.generatedCycle[index]; 
          
          // Se o subject for um array (múltiplas matérias no mesmo dia), juntá-las 
          if (Array.isArray(subject)) { 
            subject = subject.join(', '); 
          } 
          
          // Ignorar revisões e simulados na contagem 
          if (subject && !subject.includes('Revisão') && !subject.includes('Simulado')) { 
            subjects.push(subject); 
          } 
        } 
        
        return subjects; 
      } 
      
      // Função para calcular intervalo baseado em desempenho 
      getPerformanceBasedInterval(accuracy) { 
        accuracy = Math.max(0, Math.min(100, accuracy)); 
        
        if (accuracy >= 100) return 30; 
        if (accuracy >= 80) return 25; 
        if (accuracy >= 60) return 15; 
        if (accuracy >= 40) return 7; 
        return 3; 
      } 
      
      // Algoritmo SM-2 
      calculateNextReviewSM2(q, currentEF, currentInterval, repetitions) { 
        let newEF = currentEF + (0.1 - (3 - q) * (0.08 + (3 - q) * 0.02)); 
        newEF = Math.max(1.3, Math.min(newEF, 2.5)); 
        
        let newInterval; 
        
        if (q < 2) { 
          newInterval = 1; 
          repetitions = 0; 
        } else { 
          if (repetitions === 0) { 
            newInterval = 1; 
          } else if (repetitions === 1) { 
            newInterval = 3; 
          } else { 
            newInterval = Math.round(currentInterval * newEF); 
          } 
          repetitions++; 
        } 
        
        return { newInterval, newEF, repetitions }; 
      } 
      
      // Função para calcular força da memória 
      calculateMemoryStrength(topic) { 
        if (!topic.lastReviewed) return 0.5; 
        
        const now = this.getToday(); 
        const lastReview = topic.lastReviewed; 
        const diffTime = Math.max(0, now - lastReview); 
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
        
        const baseStrength = 0.9; 
        const decayRate = 0.15; 
        
        let strength = baseStrength * Math.exp(-decayRate * diffDays); 
        
        if (topic.difficultyHistory && topic.difficultyHistory.length > 0) { 
          const avgDifficulty = topic.difficultyHistory.reduce((a, b) => a + b, 0) / topic.difficultyHistory.length; 
          strength *= (1 - (avgDifficulty * 0.15)); 
        } 
        
        return Math.min(Math.max(strength, 0.1), 0.95); 
      } 
      
      // Função para obter timestamp do dia atual 
      getToday() { 
        const today = new Date(); 
        today.setHours(0, 0, 0, 0); 
        return today.getTime(); 
      } 
      
      // NOVA FUNÇÃO: Trocar Baralhos do Dia
      trocarBaralhos() {
        const ankiData = this.getModuleData('ciclos_focus_v1');
        if (!ankiData) {
          this.typeMessage("Não foi possível encontrar os dados dos baralhos Anki.", this.narrationEnabled);
          return;
        }

        // Calcular o total de blocos
        const totalDecks = ankiData.decks.length;
        const perDay = ankiData.perDay;
        const totalBlocks = Math.ceil(totalDecks / perDay);

        // Avançar para o próximo bloco (circular)
        ankiData.blockIndex = (ankiData.blockIndex + 1) % totalBlocks;
        ankiData.lastUpdated = new Date().toDateString();

        // Salvar alterações
        this.setModuleData('ciclos_focus_v1', ankiData);

        // Mensagem de confirmação
        this.typeMessage(`Baralhos trocados! Agora são os baralhos do bloco ${ankiData.blockIndex + 1} de ${totalBlocks}.`, this.narrationEnabled);
      }
      
      closeRegisterModal() { 
        document.getElementById('registerModal').style.display = 'none'; 
      } 
      
      // FUNÇÃO ATUALIZADA: Adicionar mensagem ao chat com opção de voz
      addMessageToChat(content, isUser = false, timestamp = null, messageId = null) { 
        // Verificar se a mensagem já foi exibida (evitar duplicação) 
        if (messageId && this.messageIds.has(messageId)) { 
          return; 
        } 
        
        if (messageId) { 
          this.messageIds.add(messageId); 
        } 
        
        const chatMessages = document.getElementById('chatMessages'); 
        const messageContainer = document.createElement('div'); 
        messageContainer.className = `message-container ${isUser ? 'user-container' : 'bot-container'}`; 
        
        if (!isUser) { 
          const avatar = document.createElement('div'); 
          avatar.className = 'avatar bot-avatar-small'; 
          avatar.innerHTML = '<i class="fas fa-robot"></i>'; 
          messageContainer.appendChild(avatar); 
        } 
        
        const messageBubble = document.createElement('div'); 
        messageBubble.className = `message-bubble ${isUser ? 'user-bubble' : 'bot-bubble'}`; 
        
        // Processar markdown simples (substituir *texto* por <strong>texto</strong>) 
        const processedContent = this.parseMarkdown(content); 
        
        const messageContent = document.createElement('div'); 
        messageContent.className = 'message-content'; 
        messageContent.innerHTML = processedContent; 
        
        const messageTime = document.createElement('div'); 
        messageTime.className = 'bubble-time'; 
        messageTime.textContent = timestamp ? this.formatTime(new Date(timestamp)) : this.formatTime(new Date()); 
        
        messageBubble.appendChild(messageContent); 
        messageBubble.appendChild(messageTime); 
        
        // Adicionar reação para mensagens do usuário 
        if (isUser) { 
          const reaction = document.createElement('div'); 
          reaction.className = 'message-reaction'; 
          reaction.innerHTML = '<span class="reaction-icon"><i class="fas fa-check-double"></i></span>'; 
          messageBubble.appendChild(reaction); 
        } 
        
        messageContainer.appendChild(messageBubble); 
        
        if (isUser) { 
          const avatar = document.createElement('div'); 
          avatar.className = 'avatar user-avatar-small'; 
          avatar.innerHTML = '<i class="fas fa-user"></i>'; 
          messageContainer.appendChild(avatar); 
        } 
        
        chatMessages.appendChild(messageContainer); 
        
        // Scroll para a última mensagem 
        chatMessages.scrollTop = chatMessages.scrollHeight; 
        
        // Salvar no histórico (limitado a 3 mensagens) 
        this.chatHistory.push({ 
          content: content, 
          isUser: isUser, 
          timestamp: timestamp || new Date().toISOString() 
        }); 
        
        // Manter apenas as últimas 3 mensagens 
        if (this.chatHistory.length > 3) { 
          this.chatHistory = this.chatHistory.slice(-3); 
        } 
        
        localStorage.setItem('chatHistory', JSON.stringify(this.chatHistory)); 
        
        // Reproduzir mensagem em voz se for do bot e narração estiver ativada
        if (!isUser && this.narrationEnabled) {
          // Extrair apenas texto para falar (remover HTML)
          const textToSpeak = content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
          if (textToSpeak.length > 0) {
            this.speakText(textToSpeak);
          }
        }
      } 
      
      // Função para parsear markdown simples 
      parseMarkdown(text) { 
        // Substituir *texto* por <strong>texto</strong> 
        return text.replace(/\*(.*?)\*/g, '<strong>$1</strong>'); 
      } 
      
      // FUNÇÃO ATUALIZADA: Adicionar mensagem do bot com opção de voz
      addBotMessage(content, saveToHistory = true, messageId = null) { 
        if (saveToHistory) { 
          this.addMessageToChat(content, false, null, messageId); 
        } else { 
          // Não salva no histórico para mensagens de interface 
          const chatMessages = document.getElementById('chatMessages'); 
          const messageContainer = document.createElement('div'); 
          messageContainer.className = 'message-container bot-container'; 
          
          const avatar = document.createElement('div'); 
          avatar.className = 'avatar bot-avatar-small'; 
          avatar.innerHTML = '<i class="fas fa-robot"></i>'; 
          messageContainer.appendChild(avatar); 
          
          const messageBubble = document.createElement('div'); 
          messageBubble.className = 'message-bubble bot-bubble'; 
          
          // Processar markdown 
          const processedContent = this.parseMarkdown(content); 
          
          const messageContent = document.createElement('div'); 
          messageContent.className = 'message-content'; 
          messageContent.innerHTML = processedContent; 
          
          const messageTime = document.createElement('div'); 
          messageTime.className = 'bubble-time'; 
          messageTime.textContent = this.formatTime(new Date()); 
          
          messageBubble.appendChild(messageContent); 
          messageBubble.appendChild(messageTime); 
          
          messageContainer.appendChild(messageBubble); 
          chatMessages.appendChild(messageContainer); 
          
          chatMessages.scrollTop = chatMessages.scrollHeight; 
          
          // Reproduzir mensagem em voz se narração estiver ativada
          if (this.narrationEnabled) {
            const textToSpeak = content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
            if (textToSpeak.length > 0) {
              this.speakText(textToSpeak);
            }
          }
        } 
      } 
      
      // FUNÇÃO ATUALIZADA: Digitar mensagem com opção de voz
      typeMessage(text, speak = false, messageId = null) { 
        const chatMessages = document.getElementById('chatMessages'); 
        const messageContainer = document.createElement('div'); 
        messageContainer.className = 'message-container bot-container'; 
        
        const avatar = document.createElement('div'); 
        avatar.className = 'avatar bot-avatar-small'; 
        avatar.innerHTML = '<i class="fas fa-robot"></i>'; 
        messageContainer.appendChild(avatar); 
        
        const messageBubble = document.createElement('div'); 
        messageBubble.className = 'message-bubble bot-bubble'; 
        
        // Processar markdown 
        const processedText = this.parseMarkdown(text); 
        
        const messageContent = document.createElement('div'); 
        messageContent.className = 'message-content'; 
        messageContent.innerHTML = `<span class="typing-text">${processedText}</span>`; 
        
        const messageTime = document.createElement('div'); 
        messageTime.className = 'bubble-time'; 
        messageTime.textContent = this.formatTime(new Date()); 
        
        messageBubble.appendChild(messageContent); 
        messageBubble.appendChild(messageTime); 
        
        messageContainer.appendChild(messageBubble); 
        chatMessages.appendChild(messageContainer); 
        
        chatMessages.scrollTop = chatMessages.scrollHeight; 
        
        // Salvar no histórico - CORRIGIDO 
        this.chatHistory.push({ 
          content: text, 
          isUser: false, 
          timestamp: new Date().toISOString() 
        }); 
        
        // Manter apenas as últimas 3 mensagens 
        if (this.chatHistory.length > 3) { 
          this.chatHistory = this.chatHistory.slice(-3); 
        } 
        
        localStorage.setItem('chatHistory', JSON.stringify(this.chatHistory)); 
        
        // Reproduzir mensagem em voz se speak for true
        if (speak && this.narrationEnabled) {
          const textToSpeak = text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
          if (textToSpeak.length > 0) {
            this.speakText(textToSpeak);
          }
        }
      } 
      
      showTypingIndicator() { 
        const chatMessages = document.getElementById('chatMessages'); 
        const messageContainer = document.createElement('div'); 
        messageContainer.className = 'message-container bot-container'; 
        
        const avatar = document.createElement('div'); 
        avatar.className = 'avatar bot-avatar-small'; 
        avatar.innerHTML = '<i class="fas fa-robot"></i>'; 
        messageContainer.appendChild(avatar); 
        
        const typingBubble = document.createElement('div'); 
        typingBubble.className = 'typing-indicator'; 
        typingBubble.id = 'typingIndicator'; 
        typingBubble.innerHTML = ` 
          <div class="typing-dot"></div> 
          <div class="typing-dot"></div> 
          <div class="typing-dot"></div> 
        `; 
        
        messageContainer.appendChild(typingBubble); 
        chatMessages.appendChild(messageContainer); 
        
        chatMessages.scrollTop = chatMessages.scrollHeight; 
      } 
      
      hideTypingIndicator() { 
        const typingIndicator = document.getElementById('typingIndicator'); 
        if (typingIndicator) { 
          typingIndicator.parentElement.remove(); 
        } 
      } 
      
      sendMessage() { 
        const input = document.getElementById('messageInput'); 
        const message = input.value.trim(); 
        
        if (message) { 
          this.addUserMessage(message); 
          input.value = ''; 
          
          // Simular resposta do bot 
          this.showTypingIndicator(); 
          setTimeout(() => { 
            this.hideTypingIndicator(); 
            this.processUserMessage(message); 
          }, 1000 + Math.random() * 1000); 
        } 
      } 
      
      processUserMessage(message) { 
        const lowerMessage = message.toLowerCase(); 
        
        if (lowerMessage.includes('resumo') || lowerMessage.includes('como estou') || lowerMessage.includes('tarefas')) { 
          this.showDailySummary(); 
        } else if (lowerMessage.includes('registrar') || lowerMessage.includes('adicionar')) { 
          this.openRegisterModal(); 
        } else if (lowerMessage.includes('configurar') || lowerMessage.includes('config')) { 
          this.showConfigModal(); 
        } else if (lowerMessage.includes('ajuda') || lowerMessage.includes('comandos')) { 
          this.showHelp(); 
        } else if (lowerMessage.includes('info') || lowerMessage.includes('sobre')) { 
          this.showInfo(); 
        } else if (lowerMessage.includes('edital')) { 
          this.showEditalMenu(); 
        } else if (lowerMessage.includes('simulado')) { 
          this.showSimuladosMenu(); 
        } else if (lowerMessage.includes('reset')) { 
          this.showResetConfirmation(); 
        } else { 
          // Resposta padrão 
          this.typeMessage("Entendi sua mensagem! Posso te ajudar com:\n\n• <strong>Resumo do dia</strong>\n• <strong>Registrar atividades</strong>\n• <strong>Edital</strong>\n• <strong>Simulados</strong>\n• <strong>Configurações</strong>\n• <strong>Ajuda e informações</strong>\n\nO que você gostaria de fazer?", this.narrationEnabled); 
        } 
      } 
      
      showHelp() { 
        const helpCard = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-question-circle"></i> 
              <div class="message-card-title">Como posso ajudá-lo?</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-list"> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-calendar-day"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Resumo do dia</div> 
                    <div class="message-list-description">Mostrar tarefas e progresso atual</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-plus-circle"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Registrar atividades</div> 
                    <div class="message-list-description">Questões, Anki ou teoria</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-microphone-alt"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Registrar atividades por voz</div> 
                    <div class="message-list-description">Registrar atividades usando comandos de voz</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-history"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Registrar atividades de ontem</div> 
                    <div class="message-list-description">Para quando esqueceu de registrar no dia anterior</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-file-alt"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Edital</div> 
                    <div class="message-list-description">Ver progresso no edital completo ou por matéria</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-chart-line"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Simulados</div> 
                    <div class="message-list-description">Ver notas e relatórios de simulados</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-calendar-alt"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Programar Simulado</div> 
                    <div class="message-list-description">Definir intervalos para simulados</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-chart-bar"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Relatório Periódico</div> 
                    <div class="message-list-description">Gerar relatórios de desempenho</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-sync-alt"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Trocar Baralhos</div> 
                    <div class="message-list-description">Corrigir manualmente a ordem dos baralhos do dia</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-cog"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Configurar</div> 
                    <div class="message-list-description">Ajustar quantidade de matérias por dia</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-microphone-alt"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Comandos de Voz</div> 
                    <div class="message-list-description">Ver todos os comandos de voz disponíveis</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-question-circle"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Ajuda</div> 
                    <div class="message-list-description">Mostrar esta mensagem de ajuda</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-info"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Informações</div> 
                    <div class="message-list-description">Sobre o StudyFlow</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-exclamation-triangle"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Reset</div> 
                    <div class="message-list-description">Função temporária para corrigir travamentos</div> 
                  </div> 
                </div> 
              </div> 
            </div> 
          </div> 
        `; 
        this.addBotMessage(helpCard, true, 'help-message'); 
      } 
      
      showInfo() { 
        const infoCard = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-info-circle"></i> 
              <div class="message-card-title">Sobre o StudyFlow</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-text"> 
                O StudyFlow é seu assistente pessoal de estudos, integrando todas as suas ferramentas de aprendizado em um só lugar. 
              </div> 
              <div class="message-muted" style="margin-top: 10px"> 
                Comigo você pode: 
              </div> 
              <div class="message-list" style="margin-top: 8px"> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Gerenciar seu ciclo de estudos</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Registrar questões e revisões</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Acompanhar seu progresso no edital</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Analisar desempenho em simulados</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Receber alertas e lembretes</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Programar simulados</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Gerar relatórios periódicos</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Corrigir manualmente a ordem dos baralhos</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Registrar atividades do dia anterior</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Interagir por comandos de voz</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Registrar atividades por voz</div> 
                  </div> 
                </div> 
              </div> 
            </div> 
          </div> 
        `; 
        this.addBotMessage(infoCard, true, 'info-message'); 
      } 
      
      showQuickActions() { 
        this.addBotMessage(` 
          <div class="quick-actions"> 
            <button class="action-btn primary" onclick="chatBot.showDailySummary()"> 
              <i class="fas fa-calendar-day"></i> Resumo do Dia 
            </button> 
            <button class="action-btn secondary" onclick="chatBot.openRegisterModal()"> 
              <i class="fas fa-plus-circle"></i> Registrar 
            </button> 
            <!-- NOVO BOTÃO: Registrar Atividades por Voz -->
            <button class="action-btn info" onclick="chatBot.startVoiceRegistration()"> 
              <i class="fas fa-microphone-alt"></i> Registrar atividades por voz 
            </button> 
            <!-- NOVO BOTÃO: Registrar Atividades de Ontem -->
            <button class="action-btn info" onclick="chatBot.openYesterdayModal()"> 
              <i class="fas fa-history"></i> Registrar Atividades de Ontem 
            </button> 
            <button class="action-btn info" onclick="chatBot.showEditalMenu()"> 
              <i class="fas fa-file-alt"></i> Edital 
            </button> 
            <button class="action-btn info" onclick="chatBot.showSimuladosMenu()"> 
              <i class="fas fa-chart-line"></i> Simulados 
            </button> 
            <button class="action-btn info" onclick="chatBot.showSimuladoModal()"> 
              <i class="fas fa-calendar-alt"></i> Programar Simulado 
            </button> 
            <button class="action-btn info" onclick="chatBot.showRelatorioModal()"> 
              <i class="fas fa-chart-bar"></i> Relatório 
            </button> 
            <button class="action-btn info" onclick="chatBot.trocarBaralhos()"> 
              <i class="fas fa-sync-alt"></i> Trocar Baralhos 
            </button> 
            <button class="action-btn info" onclick="chatBot.showConfigModal()"> 
              <i class="fas fa-cog"></i> Configurar 
            </button> 
            <button class="action-btn info" onclick="chatBot.showVoiceCommandsModal()"> 
              <i class="fas fa-microphone-alt"></i> Comandos de Voz 
            </button> 
            <button class="action-btn info" onclick="chatBot.showHelp()"> 
              <i class="fas fa-question-circle"></i> Ajuda 
            </button> 
            <button class="action-btn info" onclick="chatBot.showInfo()"> 
              <i class="fas fa-info"></i> Informações 
            </button> 
            <button class="action-btn reset" onclick="chatBot.showResetConfirmation()"> 
              <i class="fas fa-exclamation-triangle"></i> Reset 
            </button> 
          </div> 
        `, false); 
      } 
      
      toggleEmojiPicker() { 
        // Implementação básica de emoji picker 
        const emojis = ["😊", "👍", "❤️", "🔥", "⭐", "📚", "🎯", "💡", "🚀", "✅"]; 
        
        let emojiHTML = '<div class="quick-actions">'; 
        emojis.forEach(emoji => { 
          emojiHTML += `<button class="action-btn" onclick="chatBot.addEmoji('${emoji}')">${emoji}</button>`; 
        }); 
        emojiHTML += '</div>'; 
        
        this.addBotMessage(emojiHTML, false); 
      } 
      
      addEmoji(emoji) { 
        const input = document.getElementById('messageInput'); 
        input.value += emoji; 
        input.focus(); 
      } 
      
      // Funções para o módulo Edital 
      showEditalMenu() { 
        const editalData = this.getEditalData(); 
        if (!editalData) { 
          this.typeMessage("Não encontrei dados do edital verticalizado. Verifique se você já importou um edital no módulo correspondente.", this.narrationEnabled); 
          return; 
        } 
        
        this.addBotMessage(` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-file-alt"></i> 
              <div class="message-card-title">Progresso no Edital</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-text"> 
                Você quer ver seu progresso no edital completo ou em uma matéria específica? 
              </div> 
              <div class="quick-actions" style="margin-top: 12px"> 
                <button class="action-btn primary" onclick="chatBot.showEditalCompleto()"> 
                  <i class="fas fa-chart-pie"></i> Todo o Edital 
                </button> 
                <button class="action-btn secondary" onclick="chatBot.showMateriasEdital()"> 
                  <i class="fas fa-book"></i> Matéria Específica 
                </button> 
              </div> 
            </div> 
          </div> 
        `, true, 'edital-menu'); 
      } 
      
      getEditalData() { 
        try { 
          // Buscar dados do módulo de edital verticalizado 
          const editais = JSON.parse(localStorage.getItem('editais')); 
          const editalAtivoId = localStorage.getItem('editalAtivoId'); 
          
          if (!editais || !editalAtivoId) { 
            return null; 
          } 
          
          const editalAtivo = editais.find(edital => edital.id === editalAtivoId); 
          if (!editalAtivo) { 
            return null; 
          } 
          
          // Buscar progresso do edital ativo 
          const completedTopicsKey = `completedTopics_${editalAtivoId}`; 
          const completedTopics = JSON.parse(localStorage.getItem(completedTopicsKey)) || {}; 
          
          return { 
            edital: editalAtivo, 
            progresso: completedTopics 
          }; 
        } catch (error) { 
          console.error('Erro ao buscar dados do edital:', error); 
          return null; 
        } 
      } 
      
      showEditalCompleto() { 
        const editalData = this.getEditalData(); 
        if (!editalData) { 
          this.typeMessage("Não foi possível carregar os dados do edital.", this.narrationEnabled); 
          return; 
        } 
        
        const { edital, progresso } = editalData; 
        
        // Calcular estatísticas gerais 
        let totalTopicos = 0; 
        let topicosConcluidos = 0; 
        
        edital.disciplinas.forEach(disciplina => { 
          disciplina.topicos.forEach(topico => { 
            totalTopicos++; 
            const chaveTopico = `${disciplina.nome}-${topico}`; 
            if (progresso[chaveTopico]) { 
              topicosConcluidos++; 
            } 
          }); 
        }); 
        
        const porcentagemTotal = totalTopicos > 0 ? Math.round((topicosConcluidos / totalTopicos) * 100) : 0; 
        
        // Calcular progresso por disciplina 
        const progressoDisciplinas = edital.disciplinas.map(disciplina => { 
          let topicosDisciplina = 0; 
          let concluidosDisciplina = 0; 
          
          disciplina.topicos.forEach(topico => { 
            topicosDisciplina++; 
            const chaveTopico = `${disciplina.nome}-${topico}`; 
            if (progresso[chaveTopico]) { 
              concluidosDisciplina++; 
            } 
          }); 
          
          const porcentagem = topicosDisciplina > 0 ? Math.round((concluidosDisciplina / topicosDisciplina) * 100) : 0; 
          
          return { 
            nome: disciplina.nome, 
            concluidos: concluidosDisciplina, 
            total: topicosDisciplina, 
            porcentagem: porcentagem 
          }; 
        }); 
        
        // Ordenar por porcentagem (menor para maior) 
        progressoDisciplinas.sort((a, b) => a.porcentagem - b.porcentagem); 
        
        let relatorioHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-chart-pie"></i> 
              <div class="message-card-title">Progresso Geral do Edital</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-stats"> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${porcentagemTotal}%</div> 
                  <div class="message-stat-label">Concluído</div> 
                </div> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${topicosConcluidos}/${totalTopicos}</div> 
                  <div class="message-stat-label">Tópicos</div> 
                </div> 
              </div> 
              <div class="message-progress"> 
                <div class="message-progress-bar"> 
                  <div class="message-progress-fill" style="width: ${porcentagemTotal}%"></div> 
                </div> 
                <div class="message-progress-text"> 
                  <span>0%</span> 
                  <span>${porcentagemTotal}%</span> 
                  <span>100%</span> 
                </div> 
              </div> 
              <div class="message-section"> 
                <div class="message-section-title">Progresso por Disciplina</div> 
                <div class="message-list"> 
        `; 
        
        progressoDisciplinas.forEach(disciplina => { 
          const statusClass = disciplina.porcentagem >= 80 ? 'success' : disciplina.porcentagem >= 50 ? 'warning' : 'danger'; 
          
          relatorioHTML += ` 
            <div class="message-list-item"> 
              <div class="message-list-icon"><i class="fas fa-book"></i></div> 
              <div class="message-list-content"> 
                <div class="message-list-title">${disciplina.nome}</div> 
                <div class="message-list-description"> 
                  ${disciplina.concluidos}/${disciplina.total} tópicos 
                  <span class="message-badge message-badge-${statusClass}">${disciplina.porcentagem}%</span> 
                </div> 
              </div> 
            </div> 
          `; 
        }); 
        
        relatorioHTML += ` 
                </div> 
              </div> 
            </div> 
          </div> 
        `; 
        
        this.addBotMessage(relatorioHTML, true, 'edital-completo'); 
      } 
      
      showMateriasEdital() { 
        const editalData = this.getEditalData(); 
        if (!editalData) { 
          this.typeMessage("Não foi possível carregar os dados do edital.", this.narrationEnabled); 
          return; 
        } 
        
        const { edital } = editalData; 
        
        let materiasHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-book"></i> 
              <div class="message-card-title">Selecione uma Matéria</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="quick-actions"> 
        `; 
        
        edital.disciplinas.forEach(disciplina => { 
          materiasHTML += ` 
            <button class="action-btn info" onclick="chatBot.showEditalMateria('${disciplina.nome}')"> 
              <i class="fas fa-book-open"></i> ${disciplina.nome} 
            </button> 
          `; 
        }); 
        
        materiasHTML += ` 
              </div> 
            </div> 
          </div> 
        `; 
        
        this.addBotMessage(materiasHTML, true, 'materias-edital'); 
      } 
      
      showEditalMateria(materiaNome) { 
        const editalData = this.getEditalData(); 
        if (!editalData) { 
          this.typeMessage("Não foi possível carregar os dados do edital.", this.narrationEnabled); 
          return; 
        } 
        
        const { edital, progresso } = editalData; 
        const disciplina = edital.disciplinas.find(d => d.nome === materiaNome); 
        
        if (!disciplina) { 
          this.typeMessage("Matéria não encontrada no edital.", this.narrationEnabled); 
          return; 
        } 
        
        // Calcular estatísticas da disciplina 
        let totalTopicos = 0; 
        let topicosConcluidos = 0; 
        const topicosDetalhados = []; 
        
        disciplina.topicos.forEach(topico => { 
          totalTopicos++; 
          const chaveTopico = `${disciplina.nome}-${topico}`; 
          const concluido = progresso[chaveTopico] || false; 
          
          if (concluido) { 
            topicosConcluidos++; 
          } 
          
          topicosDetalhados.push({ 
            nome: topico, 
            concluido: concluido 
          }); 
        }); 
        
        const porcentagem = totalTopicos > 0 ? Math.round((topicosConcluidos / totalTopicos) * 100) : 0; 
        
        let materiaHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-book-open"></i> 
              <div class="message-card-title">${disciplina.nome}</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-stats"> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${porcentagem}%</div> 
                  <div class="message-stat-label">Concluído</div> 
                </div> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${topicosConcluidos}/${totalTopicos}</div> 
                  <div class="message-stat-label">Tópicos</div> 
                </div> 
              </div> 
              <div class="message-progress"> 
                <div class="message-progress-bar"> 
                  <div class="message-progress-fill" style="width: ${porcentagem}%"></div> 
                </div> 
                <div class="message-progress-text"> 
                  <span>0%</span> 
                  <span>${porcentagem}%</span> 
                  <span>100%</span> 
                </div> 
              </div> 
              <div class="message-section"> 
                <div class="message-section-title">Tópicos</div> 
                <div class="message-list"> 
        `; 
        
        topicosDetalhados.forEach(topico => { 
          const statusIcon = topico.concluido ? 'check-circle' : 'circle'; 
          const statusColor = topico.concluido ? 'success' : 'gray'; 
          
          materiaHTML += ` 
            <div class="message-list-item"> 
              <div class="message-list-icon" style="color: var(--${statusColor})"> 
                <i class="fas fa-${statusIcon}"></i> 
              </div> 
              <div class="message-list-content"> 
                <div class="message-list-title">${topico.nome}</div> 
                <div class="message-list-description"> 
                  ${topico.concluido ? 'Concluído' : 'Pendente'} 
                </div> 
              </div> 
            </div> 
          `; 
        }); 
        
        materiaHTML += ` 
                </div> 
              </div> 
            </div> 
          </div> 
        `; 
        
        this.addBotMessage(materiaHTML, true, `edital-${materiaNome}`); 
      } 
      
      // Funções para o módulo Simulados 
      showSimuladosMenu() { 
        const simuladosData = this.getSimuladosData(); 
        if (!simuladosData || simuladosData.simulados.length === 0) { 
          this.typeMessage("Não encontrei dados de simulados. Verifique se você já realizou algum simulado no módulo correspondente.", this.narrationEnabled); 
          return; 
        } 
        
        this.addBotMessage(` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-chart-line"></i> 
              <div class="message-card-title">Análise de Simulados</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-text"> 
                O que você gostaria de ver? 
              </div> 
              <div class="quick-actions" style="margin-top: 12px"> 
                <button class="action-btn primary" onclick="chatBot.showUltimoSimuladoNota()"> 
                  <i class="fas fa-star"></i> Nota do Último Simulado 
                </button> 
                <button class="action-btn secondary" onclick="chatBot.showUltimoSimuladoRelatorio()"> 
                  <i class="fas fa-chart-bar"></i> Relatório Completo 
                </button> 
                <button class="action-btn info" onclick="chatBot.showUltimoSimuladoData()"> 
                  <i class="fas fa-calendar"></i> Data do Último Simulado 
                </button> 
              </div> 
            </div> 
          </div> 
        `, true, 'simulados-menu'); 
      } 
      
      getSimuladosData() { 
        try { 
          // Buscar dados do módulo de simulados 
          const simulados = JSON.parse(localStorage.getItem('simulados')) || []; 
          const provas = JSON.parse(localStorage.getItem('provas')) || []; 
          const provaAtivaId = localStorage.getItem('provaAtivaId'); 
          
          if (simulados.length === 0) { 
            return null; 
          } 
          
          // Ordenar simulados por data (mais recente primeiro) 
          simulados.sort((a, b) => new Date(b.date) - new Date(a.date)); 
          
          const ultimoSimulado = simulados[0]; 
          const prova = provas.find(p => p.id === ultimoSimulado.idProva); 
          
          return { 
            simulados: simulados, 
            ultimoSimulado: ultimoSimulado, 
            prova: prova, 
            provaAtivaId: provaAtivaId 
          }; 
        } catch (error) { 
          console.error('Erro ao buscar dados de simulados:', error); 
          return null; 
        } 
      } 
      
      showUltimoSimuladoNota() { 
        const simuladosData = this.getSimuladosData(); 
        if (!simuladosData) { 
          this.typeMessage("Não foi possível carregar os dados dos simulados.", this.narrationEnabled); 
          return; 
        } 
        
        const { ultimoSimulado, prova } = simuladosData; 
        const dataFormatada = new Date(ultimoSimulado.date).toLocaleDateString('pt-BR'); 
        
        // Determinar classificação baseada na porcentagem 
        const porcentagem = parseFloat(ultimoSimulado.totalPercentage); 
        let classificacao = ''; 
        let corClassificacao = ''; 
        
        if (porcentagem >= 90) { 
          classificacao = 'EXCELENTE'; 
          corClassificacao = 'success'; 
        } else if (porcentagem >= 80) { 
          classificacao = 'ÓTIMO'; 
          corClassificacao = 'primary'; 
        } else if (porcentagem >= 66) { 
          classificacao = 'BOM'; 
          corClassificacao = 'secondary'; 
        } else if (porcentagem >= 51) { 
          classificacao = 'MÉDIO'; 
          corClassificacao = 'warning'; 
        } else if (porcentagem >= 31) { 
          classificacao = 'FRACO'; 
          corClassificacao = 'warning'; 
        } else { 
          classificacao = 'CRÍTICO'; 
          corClassificacao = 'danger'; 
        } 
        
        const notaHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-star"></i> 
              <div class="message-card-title">Nota do Último Simulado</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-stats"> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${ultimoSimulado.totalScore}</div> 
                  <div class="message-stat-label">Pontuação</div> 
                </div> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${ultimoSimulado.totalPercentage}%</div> 
                  <div class="message-stat-label">Acertos</div> 
                </div> 
              </div> 
              <div class="message-alert message-alert-${corClassificacao}"> 
                <i class="fas fa-${porcentagem >= 66 ? 'check' : 'exclamation'}-circle"></i> 
                <div><strong>Classificação: ${classificacao}</strong></div> 
              </div> 
              <div class="message-list"> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-calendar"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Data</div> 
                    <div class="message-list-description">${dataFormatada}</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-clock"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Tempo Total</div> 
                    <div class="message-list-description">${ultimoSimulado.totalTime} minutos</div> 
                  </div> 
                </div> 
                ${prova ? ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-file-alt"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Prova</div> 
                    <div class="message-list-description">${prova.nomeConcurso} - ${prova.nomeBanca}</div> 
                  </div> 
                </div> 
                ` : ''} 
              </div> 
            </div> 
          </div> 
        `; 
        
        this.addBotMessage(notaHTML, true, 'ultimo-simulado-nota'); 
      } 
      
      showUltimoSimuladoRelatorio() { 
        const simuladosData = this.getSimuladosData(); 
        if (!simuladosData) { 
          this.typeMessage("Não foi possível carregar os dados dos simulados.", this.narrationEnabled); 
          return; 
        } 
        
        const { ultimoSimulado, prova } = simuladosData; 
        const dataFormatada = new Date(ultimoSimulado.date).toLocaleDateString('pt-BR'); 
        
        // Organizar disciplinas por categoria (se disponível) 
        const disciplinas = []; 
        
        if (prova && prova.disciplinas) { 
          Object.keys(prova.disciplinas).forEach(categoria => { 
            Object.keys(prova.disciplinas[categoria]).forEach(disciplina => { 
              if (ultimoSimulado.details[disciplina]) { 
                disciplinas.push({ 
                  nome: disciplina, 
                  categoria: categoria, 
                  detalhes: ultimoSimulado.details[disciplina], 
                  tempo: ultimoSimulado.time[disciplina] || 0 
                }); 
              } 
            }); 
          }); 
        } else { 
          // Se não houver estrutura de categorias, listar todas as disciplinas 
          Object.keys(ultimoSimulado.details).forEach(disciplina => { 
            disciplinas.push({ 
              nome: disciplina, 
              categoria: 'GERAL', 
              detalhes: ultimoSimulado.details[disciplina], 
              tempo: ultimoSimulado.time[disciplina] || 0 
            }); 
          }); 
        } 
        
        let relatorioHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-chart-bar"></i> 
              <div class="message-card-title">Relatório Completo - ${dataFormatada}</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-stats"> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${ultimoSimulado.totalScore}</div> 
                  <div class="message-stat-label">Pontuação</div> 
                </div> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${ultimoSimulado.totalPercentage}%</div> 
                  <div class="message-stat-label">Acertos</div> 
                </div> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${ultimoSimulado.totalTime}</div> 
                  <div class="message-stat-label">Minutos</div> 
                </div> 
              </div> 
              <div class="message-section"> 
                <div class="message-section-title">Desempenho por Disciplina</div> 
                <div class="message-list"> 
        `; 
        
        disciplinas.forEach(disciplina => { 
          const porcentagem = parseFloat(disciplina.detalhes.percentage); 
          let statusClass = ''; 
          if (porcentagem >= 80) statusClass = 'success'; 
          else if (porcentagem >= 60) statusClass = 'warning'; 
          else statusClass = 'danger'; 
          
          relatorioHTML += ` 
            <div class="message-list-item"> 
              <div class="message-list-icon"><i class="fas fa-book"></i></div> 
              <div class="message-list-content"> 
                <div class="message-list-title">${disciplina.nome}</div> 
                <div class="message-list-description"> 
                  ${disciplina.detalhes.correct} acertos de ${disciplina.detalhes.correct + disciplina.detalhes.errors} 
                  <span class="message-badge message-badge-${statusClass}">${disciplina.detalhes.percentage}%</span> 
                </div> 
                <div class="message-list-description"> 
                  Pontuação: ${disciplina.detalhes.score} • Tempo: ${disciplina.tempo} min 
                </div> 
              </div> 
            </div> 
          `; 
        }); 
        
        relatorioHTML += ` 
                </div> 
              </div> 
            </div> 
          </div> 
        `; 
        
        this.addBotMessage(relatorioHTML, true, 'ultimo-simulado-relatorio'); 
      } 
      
      showUltimoSimuladoData() { 
        const simuladosData = this.getSimuladosData(); 
        if (!simuladosData) { 
          this.typeMessage("Não foi possível carregar os dados dos simulados.", this.narrationEnabled); 
          return; 
        } 
        
        const { ultimoSimulado, simulados } = simuladosData; 
        const dataFormatada = new Date(ultimoSimulado.date).toLocaleDateString('pt-BR'); 
        
        const hoje = new Date(); 
        const dataSimulado = new Date(ultimoSimulado.date); 
        const diffTime = Math.abs(hoje - dataSimulado); 
        const diffDias = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        const dataHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-calendar"></i> 
              <div class="message-card-title">Data do Último Simulado</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-alert message-alert-info"> 
                <i class="fas fa-info-circle"></i> 
                <div>Seu último simulado foi realizado há <strong>${diffDias} dia(s)</strong></div> 
              </div> 
              <div class="message-list"> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-calendar-day"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Data</div> 
                    <div class="message-list-description">${dataFormatada}</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-history"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Tempo Decorrido</div> 
                    <div class="message-list-description">${diffDias} dia(s)</div> 
                  </div> 
                </div> 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-chart-line"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">Total de Simulados</div> 
                    <div class="message-list-description">${simulados.length} realizados</div> 
                  </div> 
                </div> 
              </div> 
              ${diffDias > 30 ? ` 
              <div class="message-alert message-alert-warning"> 
                <i class="fas fa-exclamation-triangle"></i> 
                <div>Faz mais de 30 dias desde seu último simulado. Considere realizar um novo para avaliar seu progresso.</div> 
              </div> 
              ` : ''} 
            </div> 
          </div> 
        `; 
        
        this.addBotMessage(dataHTML, true, 'ultimo-simulado-data'); 
      } 
      
      // Funções de alertas 
      checkAlerts() { 
        const alertas = []; 
        const hoje = new Date(); 
        
        // Verificar revisões atrasadas 
        const revisoesAtrasadas = this.calculateOverdueReviews(); 
        if (revisoesAtrasadas > 0) { 
          alertas.push({ 
            tipo: 'alert-danger', 
            icone: 'exclamation-triangle', 
            mensagem: `Você tem ${revisoesAtrasadas} revisões atrasadas!` 
          }); 
        } 
        
        // Verificar meta diária 
        const dailyCompletedReviews = this.getModuleData('dailyCompletedReviews') || 0; 
        const dailyReviewGoal = this.getModuleData('dailyReviewGoal') || 5; 
        
        // Verificar se é um novo dia 
        const lastReviewDate = this.getModuleData('lastReviewDate'); 
        const hojeStr = hoje.toISOString().split('T')[0]; 
        
        if (lastReviewDate !== hojeStr) { 
          // Resetar contador diário se for um novo dia 
          this.setModuleData('dailyCompletedReviews', 0); 
          this.setModuleData('lastReviewDate', hojeStr); 
        } else if (dailyCompletedReviews < dailyReviewGoal / 2) { 
          alertas.push({ 
            tipo: 'alert-warning', 
            icone: 'bullseye', 
            mensagem: `Você completou apenas ${dailyCompletedReviews} de ${dailyReviewGoal} revisões hoje.` 
          }); 
        } 
        
        // Verificar dias sem estudo (simulação) 
        const ultimoEstudo = localStorage.getItem('ultimoEstudo'); 
        if (ultimoEstudo) { 
          const diasSemEstudo = Math.floor((hoje - new Date(ultimoEstudo)) / (1000 * 60 * 60 * 24)); 
          if (diasSemEstudo >= 2) { 
            alertas.push({ 
              tipo: 'alert-danger', 
              icone: 'calendar-times', 
              mensagem: `Você não estuda há ${diasSemEstudo} dias!` 
            }); 
          } 
        } 
        
        return alertas; 
      } 
    } 
    
    // Inicializar o chatbot quando a página carregar 
    let chatBot; 
    document.addEventListener('DOMContentLoaded', function() { 
      chatBot = new StudyFlowChatBot(); 
    }); 
  </script>
</body>
</html>
